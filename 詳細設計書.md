# GameBargain è©³ç´°è¨­è¨ˆæ›¸

## ç›®æ¬¡
- [GameBargain è©³ç´°è¨­è¨ˆæ›¸](#gamebargain-è©³ç´°è¨­è¨ˆæ›¸)
  - [ç›®æ¬¡](#ç›®æ¬¡)
  - [1. æ¦‚è¦](#1-æ¦‚è¦)
    - [1.1 è¨­è¨ˆæ–¹é‡](#11-è¨­è¨ˆæ–¹é‡)
    - [1.2 æŠ€è¡“ä»•æ§˜è©³ç´°](#12-æŠ€è¡“ä»•æ§˜è©³ç´°)
    - [1.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶](#13-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶)
    - [1.4 é–‹ç™ºæœŸé–“](#14-é–‹ç™ºæœŸé–“)
      - [é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
  - [2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](#2-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ)
    - [2.1 ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ](#21-ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ)
    - [2.2 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚](#22-ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚)
    - [2.3 ã‚¯ãƒ©ã‚¹å›³](#23-ã‚¯ãƒ©ã‚¹å›³)
      - [2.3.1 ä¸»è¦ã‚¯ãƒ©ã‚¹æ§‹æˆ](#231-ä¸»è¦ã‚¯ãƒ©ã‚¹æ§‹æˆ)
      - [2.3.2 ã‚¯ãƒ©ã‚¹é–“ã®ä¸»è¦é–¢ä¿‚](#232-ã‚¯ãƒ©ã‚¹é–“ã®ä¸»è¦é–¢ä¿‚)
      - [2.3.3 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³](#233-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³)
  - [3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°è¨­è¨ˆ](#3-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°è¨­è¨ˆ)
    - [3.1 ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆæ¦‚è¦](#31-ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆæ¦‚è¦)
    - [3.2 ERå›³](#32-erå›³)
    - [3.3 ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°è¨­è¨ˆ](#33-ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°è¨­è¨ˆ)
      - [3.3.1 usersãƒ†ãƒ¼ãƒ–ãƒ«](#331-usersãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.2 gamesãƒ†ãƒ¼ãƒ–ãƒ«](#332-gamesãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.3 pricesãƒ†ãƒ¼ãƒ–ãƒ« (1:Né–¢ä¿‚)](#333-pricesãƒ†ãƒ¼ãƒ–ãƒ«-1né–¢ä¿‚)
      - [3.3.4 user\_favoritesãƒ†ãƒ¼ãƒ–ãƒ«](#334-user_favoritesãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.5 price\_historyãƒ†ãƒ¼ãƒ–ãƒ«](#335-price_historyãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.6 notificationsãƒ†ãƒ¼ãƒ–ãƒ«](#336-notificationsãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.7 user\_settingsãƒ†ãƒ¼ãƒ–ãƒ«](#337-user_settingsãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.8 discord\_settingsãƒ†ãƒ¼ãƒ–ãƒ«](#338-discord_settingsãƒ†ãƒ¼ãƒ–ãƒ«)
      - [3.3.9 system\_logsãƒ†ãƒ¼ãƒ–ãƒ«](#339-system_logsãƒ†ãƒ¼ãƒ–ãƒ«)
    - [3.4 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š](#34-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š)
  - [4. ã‚¯ãƒ©ã‚¹è¨­è¨ˆè©³ç´°](#4-ã‚¯ãƒ©ã‚¹è¨­è¨ˆè©³ç´°)
    - [4.1 ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚¯ãƒ©ã‚¹](#41-ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚¯ãƒ©ã‚¹)
      - [4.1.1 GameSearchService ã‚¯ãƒ©ã‚¹](#411-gamesearchservice-ã‚¯ãƒ©ã‚¹)
      - [4.1.2 PriceComparisonService ã‚¯ãƒ©ã‚¹](#412-pricecomparisonservice-ã‚¯ãƒ©ã‚¹)
      - [4.1.3 EnhancedPriceComparisonService ã‚¯ãƒ©ã‚¹](#413-enhancedpricecomparisonservice-ã‚¯ãƒ©ã‚¹)
      - [4.1.4 FavoriteService ã‚¯ãƒ©ã‚¹](#414-favoriteservice-ã‚¯ãƒ©ã‚¹)
      - [4.1.5 NotificationService ã‚¯ãƒ©ã‚¹](#415-notificationservice-ã‚¯ãƒ©ã‚¹)
      - [4.1.6 PriceChangeDetector ã‚¯ãƒ©ã‚¹](#416-pricechangedetector-ã‚¯ãƒ©ã‚¹)
      - [4.1.3 UserService ã‚¯ãƒ©ã‚¹](#413-userservice-ã‚¯ãƒ©ã‚¹)
      - [4.1.4 FavoriteService ã‚¯ãƒ©ã‚¹](#414-favoriteservice-ã‚¯ãƒ©ã‚¹-1)
      - [4.1.5 NotificationService ã‚¯ãƒ©ã‚¹](#415-notificationservice-ã‚¯ãƒ©ã‚¹-1)
    - [4.2 ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‚¯ãƒ©ã‚¹](#42-ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‚¯ãƒ©ã‚¹)
      - [4.2.1 BaseRepository ã‚¯ãƒ©ã‚¹](#421-baserepository-ã‚¯ãƒ©ã‚¹)
      - [4.2.2 GameRepository ã‚¯ãƒ©ã‚¹](#422-gamerepository-ã‚¯ãƒ©ã‚¹)
    - [4.3 å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ](#43-å¤–éƒ¨api-ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ)
      - [4.3.1 BaseAPIClient ã‚¯ãƒ©ã‚¹](#431-baseapiclient-ã‚¯ãƒ©ã‚¹)
      - [4.3.2 SteamAPIClient ã‚¯ãƒ©ã‚¹](#432-steamapiclient-ã‚¯ãƒ©ã‚¹)
    - [4.4 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«](#44-ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«)
      - [4.4.1 User ãƒ¢ãƒ‡ãƒ«](#441-user-ãƒ¢ãƒ‡ãƒ«)
      - [4.4.2 Game ãƒ¢ãƒ‡ãƒ«](#442-game-ãƒ¢ãƒ‡ãƒ«)
    - [4.5 Discord Bot ã‚¯ãƒ©ã‚¹](#45-discord-bot-ã‚¯ãƒ©ã‚¹)
      - [4.5.1 DiscordBot ã‚¯ãƒ©ã‚¹](#451-discordbot-ã‚¯ãƒ©ã‚¹)
    - [4.6 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹](#46-ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹)
      - [4.6.1 RateLimiter ã‚¯ãƒ©ã‚¹](#461-ratelimiter-ã‚¯ãƒ©ã‚¹)
  - [5. APIè©³ç´°è¨­è¨ˆ](#5-apiè©³ç´°è¨­è¨ˆ)
    - [4.1 RESTful API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ](#41-restful-api-ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)
      - [4.1.1 ã‚²ãƒ¼ãƒ é–¢é€£API](#411-ã‚²ãƒ¼ãƒ é–¢é€£api)
      - [4.1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£API](#412-ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£api)
    - [4.2 APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹å®šç¾©](#42-apiãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹å®šç¾©)
      - [4.2.1 å…±é€šãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹](#421-å…±é€šãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹)
      - [4.2.2 ã‚²ãƒ¼ãƒ é–¢é€£ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹](#422-ã‚²ãƒ¼ãƒ é–¢é€£ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹)
  - [6. æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ](#6-æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ)
    - [6.1 F001: ã‚²ãƒ¼ãƒ æ¤œç´¢æ©Ÿèƒ½](#61-f001-ã‚²ãƒ¼ãƒ æ¤œç´¢æ©Ÿèƒ½)
      - [6.1.1 å‡¦ç†ãƒ•ãƒ­ãƒ¼](#611-å‡¦ç†ãƒ•ãƒ­ãƒ¼)
      - [6.1.2 ã‚¯ãƒ©ã‚¹è¨­è¨ˆ](#612-ã‚¯ãƒ©ã‚¹è¨­è¨ˆ)
      - [5.1.3 å…¥åŠ›å€¤æ¤œè¨¼](#513-å…¥åŠ›å€¤æ¤œè¨¼)
      - [5.1.4 å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…](#514-å¤–éƒ¨api-ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…)
      - [5.1.3 å…¥åŠ›å€¤æ¤œè¨¼](#513-å…¥åŠ›å€¤æ¤œè¨¼-1)
      - [5.1.4 å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…](#514-å¤–éƒ¨api-ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…-1)
    - [6.2 F002: ä¾¡æ ¼æ¯”è¼ƒæ©Ÿèƒ½](#62-f002-ä¾¡æ ¼æ¯”è¼ƒæ©Ÿèƒ½)
      - [6.2.1 å‡¦ç†ãƒ•ãƒ­ãƒ¼](#621-å‡¦ç†ãƒ•ãƒ­ãƒ¼)
      - [6.2.2 ä¾¡æ ¼æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯](#622-ä¾¡æ ¼æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯)
    - [6.3 F003: Discordèªè¨¼æ©Ÿèƒ½](#63-f003-discordèªè¨¼æ©Ÿèƒ½)
      - [6.3.1 OAuth2ãƒ•ãƒ­ãƒ¼](#631-oauth2ãƒ•ãƒ­ãƒ¼)
      - [6.3.2 èªè¨¼å‡¦ç†å®Ÿè£…](#632-èªè¨¼å‡¦ç†å®Ÿè£…)
    - [6.4 F004: ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½](#64-f004-ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½)
      - [6.4.1 æ©Ÿèƒ½æ¦‚è¦](#641-æ©Ÿèƒ½æ¦‚è¦)
      - [6.4.2 ã‚¯ãƒ©ã‚¹è¨­è¨ˆ](#642-ã‚¯ãƒ©ã‚¹è¨­è¨ˆ)
    - [6.5 F006: ä¾¡æ ¼ç›£è¦–æ©Ÿèƒ½](#65-f006-ä¾¡æ ¼ç›£è¦–æ©Ÿèƒ½)
      - [6.5.1 æ©Ÿèƒ½æ¦‚è¦](#651-æ©Ÿèƒ½æ¦‚è¦)
      - [6.5.2 ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯](#652-ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯)
      - [6.5.3 ãƒãƒƒãƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ](#653-ãƒãƒƒãƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ)
    - [6.6 é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ](#66-é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ)
      - [6.6.1 é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹](#661-é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹)
  - [11. å®Ÿè£…è¨ˆç”»ãƒ»å„ªå…ˆåº¦](#11-å®Ÿè£…è¨ˆç”»å„ªå…ˆåº¦)
    - [11.1 é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º](#111-é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º)
      - [Phase 1: åŸºç›¤æ©Ÿèƒ½ (1é€±é–“)](#phase-1-åŸºç›¤æ©Ÿèƒ½-1é€±é–“)
      - [Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ (1é€±é–“)](#phase-2-ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½-1é€±é–“)
      - [Phase 3: Discord Bot (1é€±é–“)](#phase-3-discord-bot-1é€±é–“)
      - [Phase 4: ä¾¡æ ¼ç›£è¦–ãƒ»é€šçŸ¥ (1é€±é–“)](#phase-4-ä¾¡æ ¼ç›£è¦–é€šçŸ¥-1é€±é–“)
    - [11.2 æŠ€è¡“çš„èª²é¡Œã¨å¯¾ç­–](#112-æŠ€è¡“çš„èª²é¡Œã¨å¯¾ç­–)
      - [é«˜å„ªå…ˆåº¦èª²é¡Œ](#é«˜å„ªå…ˆåº¦èª²é¡Œ)
      - [ä¸­å„ªå…ˆåº¦èª²é¡Œ](#ä¸­å„ªå…ˆåº¦èª²é¡Œ)
    - [11.3 é‹ç”¨ãƒ»ä¿å®ˆè¨ˆç”»](#113-é‹ç”¨ä¿å®ˆè¨ˆç”»)
      - [å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹](#å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹)
      - [ç›£è¦–é …ç›®](#ç›£è¦–é …ç›®)
      - [éšœå®³å¯¾å¿œ](#éšœå®³å¯¾å¿œ)
    - [11.4 ä»Šå¾Œã®æ‹¡å¼µæ€§](#114-ä»Šå¾Œã®æ‹¡å¼µæ€§)
      - [çŸ­æœŸçš„æ‹¡å¼µ (3-6ãƒ¶æœˆ)](#çŸ­æœŸçš„æ‹¡å¼µ-3-6ãƒ¶æœˆ)
      - [ä¸­æœŸçš„æ‹¡å¼µ (6-12ãƒ¶æœˆ)](#ä¸­æœŸçš„æ‹¡å¼µ-6-12ãƒ¶æœˆ)
      - [é•·æœŸçš„å±•æœ› (1å¹´ä»¥ä¸Š)](#é•·æœŸçš„å±•æœ›-1å¹´ä»¥ä¸Š)
  - [12. æŠ€è¡“ä»•æ§˜è©³ç´°](#12-æŠ€è¡“ä»•æ§˜è©³ç´°-1)
    - [12.1 ç’°å¢ƒå¤‰æ•°è¨­å®š](#121-ç’°å¢ƒå¤‰æ•°è¨­å®š)
    - [12.2 ä¾å­˜é–¢ä¿‚ (requirements.txt)](#122-ä¾å­˜é–¢ä¿‚-requirementstxt)
    - [12.3 Dockerè¨­å®š](#123-dockerè¨­å®š)

---

## 1. æ¦‚è¦

### 1.1 è¨­è¨ˆæ–¹é‡
- **å˜ä¸€è²¬ä»»åŸå‰‡**: å„ã‚¯ãƒ©ã‚¹ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ˜ç¢ºãªè²¬ä»»ã‚’æŒã¤
- **ä¾å­˜æ€§æ³¨å…¥**: ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã¨ä¿å®ˆæ€§ã‚’å‘ä¸Š
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ“ã‚¸ãƒã‚¹ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®åˆ†é›¢
- **éåŒæœŸå‡¦ç†**: Discord Botã€ä¾¡æ ¼ç›£è¦–ãƒãƒƒãƒã®éåŒæœŸå®Ÿè¡Œ

### 1.2 æŠ€è¡“ä»•æ§˜è©³ç´°
| é …ç›® | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|------|------|-----------|------|
| Python | 3.9+ | - | ãƒ¡ã‚¤ãƒ³è¨€èª |
| Flask | 2.3+ | - | Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| Discord.py | 2.3+ | - | Discord Bot |
| SQLAlchemy | 2.0+ | - | ORM |
| Alembic | 1.11+ | - | DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ |
| Flask-WTF | 1.1+ | - | ãƒ•ã‚©ãƒ¼ãƒ ãƒ»CSRFå¯¾ç­– |
| Requests | 2.31+ | - | HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| APScheduler | 3.10+ | - | ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ© |
| Authlib | 1.2+ | - | OAuth2ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |

### 1.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶
| é …ç›® | ç›®æ¨™å€¤ | å‚™è€ƒ |
|------|--------|------|
| åŒæ™‚æ¥ç¶šãƒ¦ãƒ¼ã‚¶ãƒ¼æ•° | 100äºº | æƒ³å®šæœ€å¤§å€¤ |
| APIå¿œç­”æ™‚é–“ | 95%ile 2ç§’ä»¥ä¸‹ | å¤–éƒ¨APIä¾å­˜ã‚’é™¤ã |
| DBæ¥ç¶šãƒ—ãƒ¼ãƒ« | 10-20æ¥ç¶š | SQLAlchemyè¨­å®š |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ | 30æ—¥ | Discordèªè¨¼æ¨™æº– |
| ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTL | 5-60åˆ† | ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã«ã‚ˆã‚Šèª¿æ•´ |

### 1.4 é–‹ç™ºæœŸé–“
- **æœŸé–“**: 1ãƒ¶æœˆ
- **ãƒ•ã‚§ãƒ¼ã‚º**: ä»¥ä¸‹ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦é€²è¡Œ

#### é–‹ç™ºã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
| ãƒ•ã‚§ãƒ¼ã‚º | æœŸé–“ | å†…å®¹ |
|----------|------|------|
| Phase 1 | 1é€±é–“ | åŸºç›¤æ©Ÿèƒ½ã®å®Ÿè£… |
| Phase 2 | 1é€±é–“ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£… |
| Phase 3 | 1é€±é–“ | Discord Botã®é–‹ç™º |
| Phase 4 | 1é€±é–“ | ä¾¡æ ¼ç›£è¦–ãƒ»é€šçŸ¥æ©Ÿèƒ½ã®å®Ÿè£… |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 2.1 ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presentation Layer (Web UI)         â”‚
â”‚ - Flask Routes                      â”‚
â”‚ - Jinja2 Templates                  â”‚
â”‚ - Static Files                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Application Layer                   â”‚
â”‚ - Web Controllers                   â”‚
â”‚ - Discord Bot Commands              â”‚
â”‚ - API Endpoints                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Domain/Service Layer                â”‚
â”‚ - Game Service                      â”‚
â”‚ - Price Service                     â”‚
â”‚ - User Service                      â”‚
â”‚ - Notification Service              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Infrastructure Layer                â”‚
â”‚ - External API Clients              â”‚
â”‚ - Database Access                   â”‚
â”‚ - Authentication                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚
![ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚å›³](ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¾å­˜é–¢ä¿‚å›³.drawio.png)

### 2.3 ã‚¯ãƒ©ã‚¹å›³
![ã‚¯ãƒ©ã‚¹å›³](ã‚¯ãƒ©ã‚¹å›³.drawio.png)

#### 2.3.1 ä¸»è¦ã‚¯ãƒ©ã‚¹æ§‹æˆ

**ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« (é’è‰²):**
- **User**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - Discordèªè¨¼æƒ…å ±ã€ãƒ—ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- **Game**: ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - Steam/Epic Game IDã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
- **Price**: ä¾¡æ ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - ç¾åœ¨ä¾¡æ ¼ã€ã‚»ãƒ¼ãƒ«æƒ…å ±
- **Favorite**: ãŠæ°—ã«å…¥ã‚Šã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ - é€šçŸ¥è¨­å®šã€ä¾¡æ ¼é–¾å€¤

**ã‚µãƒ¼ãƒ“ã‚¹å±¤ (é»„è‰²):**
- **GameSearchService**: ã‚²ãƒ¼ãƒ æ¤œç´¢ãƒ»å¤–éƒ¨APIçµ±åˆ
- **PriceComparisonService**: ä¾¡æ ¼æ¯”è¼ƒãƒ»åˆ†æ
- **EnhancedPriceComparisonService**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼å–å¾— (ç¶™æ‰¿)
- **FavoriteService**: ãŠæ°—ã«å…¥ã‚Šç®¡ç†ãƒ»é€šçŸ¥è¨­å®š
- **NotificationService**: é€šçŸ¥ä½œæˆãƒ»Discordé€ä¿¡
- **PriceChangeDetector**: ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥ãƒ»è‡ªå‹•é€šçŸ¥

**å¤–éƒ¨APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (ç·‘è‰²):**
- **SteamAPIClient**: Steam Web APIé€£æºãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç®¡ç†
- **EpicAPIClient**: Epic Games Store APIé€£æº

**ãƒªãƒã‚¸ãƒˆãƒªå±¤ (èµ¤è‰²):**
- **UserRepository**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
- **GameRepository**: ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ»æ¤œç´¢
- **PriceRepository**: ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ»å±¥æ­´ç®¡ç†
- **FavoriteRepository**: ãŠæ°—ã«å…¥ã‚Šãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹

**èªè¨¼ãƒ»Discord (ç´«è‰²):**
- **DiscordAuthService**: OAuth2èªè¨¼ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—

#### 2.3.2 ã‚¯ãƒ©ã‚¹é–“ã®ä¸»è¦é–¢ä¿‚

**é›†ç´„ãƒ»é–¢é€£é–¢ä¿‚:**
- `User` â†’ `Favorite` (1:N) - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¤‡æ•°ã®ãŠæ°—ã«å…¥ã‚Šã‚’æŒã¤
- `Game` â†’ `Price` (1:N) - ã‚²ãƒ¼ãƒ ã¯è¤‡æ•°ã®ä¾¡æ ¼æƒ…å ±ã‚’æŒã¤
- `Game` â† `Favorite` (N:1) - ãŠæ°—ã«å…¥ã‚Šã¯ã‚²ãƒ¼ãƒ ã‚’å‚ç…§

**ä¾å­˜é–¢ä¿‚:**
- `GameSearchService` â†’ `SteamAPIClient`, `EpicAPIClient`, `GameRepository`
- `PriceComparisonService` â†’ `PriceRepository`
- `EnhancedPriceComparisonService` â†’ `SteamAPIClient`, `EpicAPIClient` (ç¶™æ‰¿)
- `FavoriteService` â†’ `UserRepository`, `GameRepository`, `FavoriteRepository`
- `NotificationService` â†’ `UserRepository`
- `PriceChangeDetector` â†’ `PriceRepository`, `NotificationService`

**ç¶™æ‰¿é–¢ä¿‚:**
- `EnhancedPriceComparisonService` extends `PriceComparisonService`

#### 2.3.3 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

**ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:**
1. **ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤**: FastAPI ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
2. **ã‚µãƒ¼ãƒ“ã‚¹å±¤**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ (Service classes)
3. **ãƒªãƒã‚¸ãƒˆãƒªå±¤**: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æŠ½è±¡åŒ– (Repository classes)
4. **ã‚¤ãƒ³ãƒ•ãƒ©å±¤**: å¤–éƒ¨APIãƒ»Discord Bot

**ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆ (DDD) è¦ç´ :**
- **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£**: User, Game, Price, Favorite
- **ã‚µãƒ¼ãƒ“ã‚¹**: ã‚²ãƒ¼ãƒ æ¤œç´¢ã€ä¾¡æ ¼æ¯”è¼ƒã€é€šçŸ¥å‡¦ç†
- **ãƒªãƒã‚¸ãƒˆãƒª**: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®æŠ½è±¡åŒ–

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°è¨­è¨ˆ

### 3.1 ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆæ¦‚è¦
**ä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«:**
1. **users** - ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãƒ»Discordèªè¨¼ç®¡ç†
2. **games** - ã‚²ãƒ¼ãƒ åŸºæœ¬æƒ…å ±ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
3. **prices** - ç¾åœ¨ä¾¡æ ¼æƒ…å ±ï¼ˆæœ€æ–°ä¾¡æ ¼ã®ã¿ï¼‰
4. **price_history** - ä¾¡æ ¼å¤‰å‹•å±¥æ­´ï¼ˆæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ï¼‰
5. **user_favorites** - ãŠæ°—ã«å…¥ã‚Šã‚²ãƒ¼ãƒ ç®¡ç†
6. **notifications** - é€šçŸ¥å±¥æ­´ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
7. **user_settings** - ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹åˆ¥è¨­å®š
8. **discord_settings** - Discord botè¨­å®šãƒ»ãƒãƒ£ãƒ³ãƒãƒ«ç®¡ç†
9. **system_logs** - ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ãƒ»ç›£è¦–ãƒ‡ãƒ¼ã‚¿

### 3.2 ERå›³
![ERå›³](ERå›³.drawio.png)

### 3.3 ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°è¨­è¨ˆ

#### 3.3.1 usersãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
    discord_id VARCHAR(20) UNIQUE NOT NULL,
    username VARCHAR(100) NOT NULL,
    discriminator VARCHAR(4), -- Discord#0000å½¢å¼ã®ã‚¿ã‚°
    avatar_url VARCHAR(255),
    email VARCHAR(255), -- Discord OAuth scope: email
    access_token TEXT, -- Discord OAuth token (æš—å·åŒ–)
    refresh_token TEXT, -- Discord refresh token (æš—å·åŒ–)
    token_expires_at TIMESTAMP,
    guild_ids JSON, -- å‚åŠ ã‚µãƒ¼ãƒãƒ¼IDé…åˆ—
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP,
    preferences JSON, -- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š (é€šçŸ¥è¨­å®šç­‰)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_users_discord_id ON users(discord_id);
CREATE INDEX idx_users_is_active ON users(is_active);
CREATE INDEX idx_users_last_login ON users(last_login_at);
```

#### 3.3.2 gamesãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE games (
    game_id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(200) NOT NULL,
    normalized_title VARCHAR(200) NOT NULL, -- æ¤œç´¢ç”¨æ­£è¦åŒ–ã‚¿ã‚¤ãƒˆãƒ«
    developer VARCHAR(100),
    publisher VARCHAR(100),
    steam_app_id VARCHAR(20) UNIQUE,
    epic_game_id VARCHAR(50),
    image_url VARCHAR(255),
    description TEXT,
    genres JSON, -- ã‚¸ãƒ£ãƒ³ãƒ«é…åˆ—
    release_date DATE,
    steam_rating DECIMAL(3,2), -- Steamè©•ä¾¡ (0-100)
    metacritic_score INTEGER, -- Metacritic ã‚¹ã‚³ã‚¢
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_games_normalized_title ON games(normalized_title);
CREATE INDEX idx_games_steam_app_id ON games(steam_app_id);
CREATE INDEX idx_games_is_active ON games(is_active);
CREATE UNIQUE INDEX idx_games_steam_epic ON games(steam_app_id, epic_game_id);
```

#### 3.3.3 pricesãƒ†ãƒ¼ãƒ–ãƒ« (1:Né–¢ä¿‚)
```sql
CREATE TABLE prices (
    price_id INTEGER PRIMARY KEY AUTOINCREMENT,
    game_id INTEGER NOT NULL,
    store VARCHAR(20) NOT NULL, -- 'steam', 'epic'
    regular_price DECIMAL(10,2),
    sale_price DECIMAL(10,2),
    discount_rate INTEGER DEFAULT 0, -- å‰²å¼•ç‡ (0-100)
    currency VARCHAR(3) DEFAULT 'JPY',
    is_on_sale BOOLEAN DEFAULT FALSE,
    sale_start_date TIMESTAMP,
    sale_end_date TIMESTAMP,
    store_url VARCHAR(500), -- è³¼å…¥ãƒšãƒ¼ã‚¸URL
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (game_id) REFERENCES games(game_id) ON DELETE CASCADE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_prices_game_store ON prices(game_id, store);
CREATE INDEX idx_prices_is_on_sale ON prices(is_on_sale);
CREATE INDEX idx_prices_created_at ON prices(created_at);

-- ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª¬æ˜ã€‘
-- games (1) : prices (N) ã®é–¢ä¿‚
-- 1ã¤ã®ã‚²ãƒ¼ãƒ ã«å¯¾ã—ã¦è¤‡æ•°ã®ä¾¡æ ¼æƒ…å ±ãŒå­˜åœ¨ï¼š
--
-- â—† ç¾åœ¨ä¾¡æ ¼ï¼ˆpricesãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰:
-- - å„ã‚¹ãƒˆã‚¢ã®ã€Œæœ€æ–°ä¾¡æ ¼ã€ã®ã¿ã‚’ä¿æŒï¼ˆæœ€å¤§2ãƒ¬ã‚³ãƒ¼ãƒ‰/ã‚²ãƒ¼ãƒ ï¼‰
-- - Steam: æœ€æ–°ã®ä¾¡æ ¼ãƒ»ã‚»ãƒ¼ãƒ«æƒ…å ±
-- - Epic:  æœ€æ–°ã®ä¾¡æ ¼ãƒ»ã‚»ãƒ¼ãƒ«æƒ…å ±
-- 
-- â—† ä¾¡æ ¼å±¥æ­´ï¼ˆprice_historyãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰:
-- - ä¾¡æ ¼å¤‰å‹•ã®ã€Œå±¥æ­´ã€ã‚’æ™‚ç³»åˆ—ã§è“„ç©ï¼ˆå¤šæ•°ãƒ¬ã‚³ãƒ¼ãƒ‰/ã‚²ãƒ¼ãƒ ï¼‰
-- - ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥æ™‚ã«æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰è¿½åŠ 
--
-- â—† ãƒ†ãƒ¼ãƒ–ãƒ«åˆ†é›¢ã®ç†ç”±:
-- - é »ç¹ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€Œç¾åœ¨ä¾¡æ ¼ã€ã¨ã€åˆ†æç”¨ã®ã€Œå±¥æ­´ã€ã‚’åˆ†é›¢
-- - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼ˆä¾¡æ ¼æ¯”è¼ƒæ™‚ã¯ç¾åœ¨ä¾¡æ ¼ã®ã¿ã‚¯ã‚¨ãƒªï¼‰
-- - ãƒ‡ãƒ¼ã‚¿é‡åˆ¶å¾¡ï¼ˆç¾åœ¨ä¾¡æ ¼ã¯å¸¸ã«æœ€æ–°2ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼‰
```

#### 3.3.4 user_favoritesãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE user_favorites (
    favorite_id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    game_id INTEGER NOT NULL,
    notification_enabled BOOLEAN DEFAULT TRUE,
    price_threshold DECIMAL(10,2), -- é€šçŸ¥ã™ã‚‹ä¾¡æ ¼é–¾å€¤
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (game_id) REFERENCES games(game_id) ON DELETE CASCADE,
    UNIQUE(user_id, game_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_favorites_user_id ON user_favorites(user_id);
CREATE INDEX idx_user_favorites_notification ON user_favorites(notification_enabled);
```

#### 3.3.5 price_historyãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE price_history (
    history_id INTEGER PRIMARY KEY AUTOINCREMENT,
    game_id INTEGER NOT NULL,
    store VARCHAR(20) NOT NULL,
    price DECIMAL(10,2),
    discount_rate INTEGER DEFAULT 0,
    change_type VARCHAR(20), -- 'price_increase', 'price_decrease', 'sale_start', 'sale_end'
    previous_price DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (game_id) REFERENCES games(game_id) ON DELETE CASCADE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_price_history_game_store ON price_history(game_id, store);
CREATE INDEX idx_price_history_created_at ON price_history(created_at);


```

#### 3.3.6 notificationsãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE notifications (
    notification_id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    game_id INTEGER,
    notification_type VARCHAR(50), -- 'price_drop', 'sale_start', 'sale_end', 'free_game'
    title VARCHAR(200),
    message TEXT,
    discord_channel_id VARCHAR(20),
    is_sent BOOLEAN DEFAULT FALSE,
    sent_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
    FOREIGN KEY (game_id) REFERENCES games(game_id) ON DELETE SET NULL
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_sent ON notifications(is_sent);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);
```

#### 3.3.7 user_settingsãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE user_settings (
    setting_id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    notification_enabled BOOLEAN DEFAULT TRUE,
    notification_frequency VARCHAR(20) DEFAULT 'daily', -- 'realtime', 'daily', 'weekly'
    price_threshold DECIMAL(10,2), -- é€šçŸ¥ã™ã‚‹ä¾¡æ ¼é–¾å€¤ï¼ˆã“ã®ä¾¡æ ¼ä»¥ä¸‹ã§ã‚»ãƒ¼ãƒ«é€šçŸ¥ï¼‰
    preferred_currency VARCHAR(3) DEFAULT 'JPY',
    language VARCHAR(10) DEFAULT 'ja',
    timezone VARCHAR(50) DEFAULT 'Asia/Tokyo',
    email_notifications BOOLEAN DEFAULT FALSE,
    discord_notifications BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    UNIQUE(user_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_settings_user_id ON user_settings(user_id);
CREATE INDEX idx_user_settings_notification_enabled ON user_settings(notification_enabled);
```

#### 3.3.8 discord_settingsãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE discord_settings (
    setting_id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    guild_id VARCHAR(20), -- Discordã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚®ãƒ«ãƒ‰ï¼‰ID
    channel_id VARCHAR(20), -- é€šçŸ¥é€ä¿¡å…ˆãƒãƒ£ãƒ³ãƒãƒ«ID
    bot_enabled BOOLEAN DEFAULT TRUE,
    notification_types JSON, -- é€šçŸ¥ã‚¿ã‚¤ãƒ—é…åˆ— ['price_drop', 'sale_start', 'free_game']
    notification_format VARCHAR(50) DEFAULT 'embed', -- 'embed', 'text'
    mention_role_id VARCHAR(20), -- ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å¯¾è±¡ãƒ­ãƒ¼ãƒ«ID
    quiet_hours_start TIME, -- é™éŸ³æ™‚é–“é–‹å§‹
    quiet_hours_end TIME, -- é™éŸ³æ™‚é–“çµ‚äº†
    webhook_url VARCHAR(500), -- Discord Webhook URL (æš—å·åŒ–)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_discord_settings_user_id ON discord_settings(user_id);
CREATE INDEX idx_discord_settings_guild_id ON discord_settings(guild_id);
CREATE INDEX idx_discord_settings_bot_enabled ON discord_settings(bot_enabled);
```

#### 3.3.9 system_logsãƒ†ãƒ¼ãƒ–ãƒ«
```sql
CREATE TABLE system_logs (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    log_level VARCHAR(10) NOT NULL, -- 'DEBUG', 'INFO', 'WARNING', 'ERROR', 'CRITICAL'
    module VARCHAR(50), -- 'api', 'bot', 'scraper', 'auth', 'scheduler'
    function_name VARCHAR(100),
    message TEXT NOT NULL,
    error_details TEXT, -- ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼è©³ç´°
    user_id INTEGER,
    session_id VARCHAR(100),
    ip_address VARCHAR(45), -- IPv4/IPv6å¯¾å¿œ
    user_agent TEXT,
    request_path VARCHAR(500),
    execution_time DECIMAL(10,6), -- å®Ÿè¡Œæ™‚é–“ï¼ˆç§’ï¼‰
    memory_usage INTEGER, -- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ï¼ˆMBï¼‰
    api_endpoint VARCHAR(200),
    steam_api_calls INTEGER DEFAULT 0, -- Steam APIå‘¼ã³å‡ºã—å›æ•°
    epic_api_calls INTEGER DEFAULT 0, -- Epic APIå‘¼ã³å‡ºã—å›æ•°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_system_logs_log_level ON system_logs(log_level);
CREATE INDEX idx_system_logs_module ON system_logs(module);
CREATE INDEX idx_system_logs_created_at ON system_logs(created_at);
CREATE INDEX idx_system_logs_user_id ON system_logs(user_id);
CREATE INDEX idx_system_logs_api_endpoint ON system_logs(api_endpoint);

-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆæœˆæ¬¡ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
CREATE INDEX idx_system_logs_created_month ON system_logs(strftime('%Y-%m', created_at));
```

### 3.4 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
```python
# config.py
import os
from datetime import timedelta

class Config:
    # Database
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or 'sqlite:///data/gamebargain.db'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        'pool_size': 10,
        'pool_recycle': 3600,
        'pool_pre_ping': True,
        'max_overflow': 20,
    }
    
    # Session (Discordèªè¨¼æ¨™æº–)
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'dev-secret-key'
    PERMANENT_SESSION_LIFETIME = timedelta(days=30)  # Discordèªè¨¼æ¨™æº–æœŸé–“
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    
    # Discord OAuth
    DISCORD_CLIENT_ID = os.environ.get('DISCORD_CLIENT_ID')
    DISCORD_CLIENT_SECRET = os.environ.get('DISCORD_CLIENT_SECRET')
    DISCORD_BOT_TOKEN = os.environ.get('DISCORD_BOT_TOKEN')
    DISCORD_REDIRECT_URI = os.environ.get('DISCORD_REDIRECT_URI')
    
    # External APIs
    STEAM_API_KEY = os.environ.get('STEAM_API_KEY')
    
    # Rate Limiting (100ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ³å®š)
    STEAM_API_RATE_LIMIT = 10  # requests per second
    EPIC_API_RATE_LIMIT = 5    # requests per second
    
    # Cache Settings
    CACHE_TYPE = "simple"  # ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
    CACHE_DEFAULT_TIMEOUT = 300  # 5åˆ†
```

---

## 4. ã‚¯ãƒ©ã‚¹è¨­è¨ˆè©³ç´°

### 4.1 ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‚¯ãƒ©ã‚¹

#### 4.1.1 GameSearchService ã‚¯ãƒ©ã‚¹
```python
class GameSearchService:
    """ã‚²ãƒ¼ãƒ æ¤œç´¢ãƒ»å¤–éƒ¨APIçµ±åˆã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, steam_client: SteamAPIClient, 
                 epic_client: EpicAPIClient,
                 game_repository: GameRepository):
        self.steam_client = steam_client
        self.epic_client = epic_client
        self.game_repository = game_repository
    
    async def search_games(self, query: str, filters: SearchFilters) -> SearchResult:
        """ã‚²ãƒ¼ãƒ æ¤œç´¢ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
        local_games = await self._search_local_games(query, filters)
        external_games = await self._search_external_apis(query)
        merged_results = self._merge_results(local_games, external_games)
        enriched_results = await self._enrich_with_prices(merged_results)
        return SearchResult(games=enriched_results)
    
    async def _search_local_games(self, query: str, filters: SearchFilters) -> List[Game]:
        """ãƒ­ãƒ¼ã‚«ãƒ«DBã‹ã‚‰ã‚²ãƒ¼ãƒ æ¤œç´¢"""
        return await self.game_repository.search_by_title(query, filters)
    
    async def _search_external_apis(self, query: str) -> List[Game]:
        """å¤–éƒ¨APIã‹ã‚‰ã‚²ãƒ¼ãƒ æ¤œç´¢"""
        steam_results = await self.steam_client.search_games(query)
        epic_results = await self.epic_client.search_games(query)
        return steam_results + epic_results
    
    def _merge_results(self, local: List[Game], external: List[Game]) -> List[Game]:
        """æ¤œç´¢çµæœã®ãƒãƒ¼ã‚¸ãƒ»é‡è¤‡é™¤å»"""
        pass
    
    async def _enrich_with_prices(self, games: List[Game]) -> List[Game]:
        """ä¾¡æ ¼æƒ…å ±ã®ä»˜ä¸"""
        pass
```

#### 4.1.2 PriceComparisonService ã‚¯ãƒ©ã‚¹  
```python
class PriceComparisonService:
    """ä¾¡æ ¼æ¯”è¼ƒãƒ»åˆ†æã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, price_repository: PriceRepository):
        self.price_repository = price_repository
    
    async def compare_prices(self, game_id: int) -> PriceComparison:
        """ä¾¡æ ¼æ¯”è¼ƒå‡¦ç†"""
        prices = await self.price_repository.get_latest_prices(game_id)
        cheapest = self._find_cheapest_price(prices)
        discounts = self._calculate_discounts(prices)
        return PriceComparison(
            game_id=game_id,
            prices=prices,
            cheapest_price=cheapest,
            discount_info=discounts
        )
    
    def _find_cheapest_price(self, prices: List[Price]) -> PriceInfo:
        """æœ€å®‰ä¾¡æ ¼ã®ç‰¹å®š"""
        return min(prices, key=lambda p: p.get_effective_price())
    
    def _calculate_discounts(self, prices: List[Price]) -> DiscountInfo:
        """å‰²å¼•æƒ…å ±ã®è¨ˆç®—"""
        pass
```

#### 4.1.3 EnhancedPriceComparisonService ã‚¯ãƒ©ã‚¹
```python
class EnhancedPriceComparisonService(PriceComparisonService):
    """ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼å–å¾—ã‚µãƒ¼ãƒ“ã‚¹ (ç¶™æ‰¿)"""
    
    def __init__(self, price_repository: PriceRepository,
                 steam_client: SteamAPIClient,
                 epic_client: EpicAPIClient):
        super().__init__(price_repository)
        self.steam_client = steam_client
        self.epic_client = epic_client
    
    async def get_real_time_prices(self, game_id: int) -> PriceComparison:
        """ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼å–å¾—ãƒ»æ¯”è¼ƒ"""
        game = await self.price_repository.get_game_by_id(game_id)
        steam_price = await self._get_steam_price(game.steam_app_id)
        epic_price = await self._get_epic_price(game.epic_game_id)
        
        real_time_prices = [steam_price, epic_price]
        return await self.compare_prices_with_data(real_time_prices)
    
    async def _get_steam_price(self, app_id: str) -> PriceInfo:
        """Steamä¾¡æ ¼ã®å–å¾—"""
        return await self.steam_client.get_app_details(app_id)
    
    async def _get_epic_price(self, game_id: str) -> PriceInfo:
        """Epic Gamesä¾¡æ ¼ã®å–å¾—"""
        return await self.epic_client.get_game_details(game_id)
```

#### 4.1.4 FavoriteService ã‚¯ãƒ©ã‚¹
```python
class FavoriteService:
    """ãŠæ°—ã«å…¥ã‚Šç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, user_repository: UserRepository,
                 game_repository: GameRepository,
                 favorite_repository: FavoriteRepository):
        self.user_repository = user_repository
        self.game_repository = game_repository
        self.favorite_repository = favorite_repository
    
    async def add_favorite(self, user_id: int, game_id: int, 
                          price_threshold: Optional[Decimal] = None) -> Favorite:
        """ãŠæ°—ã«å…¥ã‚Šè¿½åŠ """
        favorite = Favorite(
            user_id=user_id,
            game_id=game_id,
            notification_enabled=True,
            price_threshold=price_threshold,
            created_at=datetime.utcnow()
        )
        return await self.favorite_repository.save(favorite)
    
    async def remove_favorite(self, user_id: int, game_id: int) -> bool:
        """ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤"""
        favorite = await self.favorite_repository.get_by_user_game(user_id, game_id)
        if favorite:
            return await self.favorite_repository.delete(favorite.favorite_id)
        return False
    
    async def get_user_favorites(self, user_id: int) -> List[GameWithFavorite]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠæ°—ã«å…¥ã‚Šä¸€è¦§å–å¾—"""
        favorites = await self.favorite_repository.get_user_favorites(user_id)
        return await self._enrich_with_game_data(favorites)
    
    async def update_notification_settings(self, favorite_id: int, 
                                         enabled: bool, threshold: Decimal) -> Favorite:
        """é€šçŸ¥è¨­å®šã®æ›´æ–°"""
        favorite = await self.favorite_repository.get_by_id(favorite_id)
        favorite.notification_enabled = enabled
        favorite.price_threshold = threshold
        return await self.favorite_repository.save(favorite)
```

#### 4.1.5 NotificationService ã‚¯ãƒ©ã‚¹
```python
class NotificationService:
    """é€šçŸ¥ä½œæˆãƒ»é€ä¿¡ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, discord_bot: DiscordBot,
                 user_repository: UserRepository):
        self.discord_bot = discord_bot
        self.user_repository = user_repository
    
    async def create_price_notification(self, user_id: int, 
                                      price_change: PriceChange) -> Notification:
        """ä¾¡æ ¼å¤‰å‹•é€šçŸ¥ã®ä½œæˆ"""
        user = await self.user_repository.get_by_id(user_id)
        message = self._generate_notification_message(price_change)
        
        notification = Notification(
            user_id=user_id,
            type="price_drop",
            title=f"{price_change.game_title}ã®ä¾¡æ ¼ãŒä¸‹ãŒã‚Šã¾ã—ãŸï¼",
            message=message,
            sent_at=datetime.utcnow()
        )
        
        success = await self._send_discord_notification(user, notification)
        notification.status = "sent" if success else "failed"
        return notification
    
    def _generate_notification_message(self, price_change: PriceChange) -> str:
        """é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ"""
        return f"""
ğŸ® **{price_change.game_title}**
ğŸ’° ä¾¡æ ¼: ~~{price_change.old_price}å††~~ â†’ **{price_change.new_price}å††**
ğŸ“‰ å‰²å¼•: **{price_change.discount_rate}%OFF**
ğŸª ã‚¹ãƒˆã‚¢: {price_change.store}
ğŸ”— [è³¼å…¥ãƒšãƒ¼ã‚¸]({price_change.store_url})
"""
    
    async def _send_discord_notification(self, user: User, 
                                       notification: Notification) -> bool:
        """Discordé€šçŸ¥ã®é€ä¿¡"""
        try:
            await self.discord_bot.send_direct_message(
                user.discord_id, 
                notification.message
            )
            return True
        except Exception as e:
            logger.error(f"Discord notification failed: {e}")
            return False
```

#### 4.1.6 PriceChangeDetector ã‚¯ãƒ©ã‚¹
```python
class PriceChangeDetector:
    """ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥ãƒ»è‡ªå‹•é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, price_repository: PriceRepository,
                 notification_service: NotificationService):
        self.price_repository = price_repository
        self.notification_service = notification_service
    
    async def detect_price_changes(self) -> List[PriceChange]:
        """ä¾¡æ ¼å¤‰å‹•ã®æ¤œçŸ¥"""
        latest_prices = await self.price_repository.get_latest_prices()
        changes = []
        
        for price in latest_prices:
            change = await self._analyze_price_change(price)
            if change:
                changes.append(change)
        
        return changes
    
    async def process_price_changes(self, changes: List[PriceChange]) -> None:
        """ä¾¡æ ¼å¤‰å‹•ã®å‡¦ç†ãƒ»é€šçŸ¥"""
        for change in changes:
            change_type = self._determine_change_type(change)
            if change_type in ["price_drop", "sale_start"]:
                users_to_notify = await self._get_users_to_notify(change.game_id)
                await self._notify_users(users_to_notify, change)
    
    def _determine_change_type(self, change: PriceChange) -> str:
        """å¤‰å‹•ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š"""
        if change.new_price < change.old_price:
            return "price_drop"
        elif change.is_sale_start:
            return "sale_start"
        else:
            return "price_increase"
    
    async def _get_users_to_notify(self, game_id: int) -> List[User]:
        """é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—"""
        return await self.price_repository.get_users_for_notification(game_id)
```

#### 4.1.3 UserService ã‚¯ãƒ©ã‚¹
```python
class UserService:
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, user_repository: UserRepository,
                 user_settings_repository: UserSettingsRepository):
        self.user_repository = user_repository
        self.user_settings_repository = user_settings_repository
    
    async def authenticate_discord_user(self, discord_data: dict) -> User:
        """Discordèªè¨¼å‡¦ç†"""
        pass
    
    async def get_user_profile(self, user_id: int) -> UserProfile:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—"""
        pass
    
    async def update_user_settings(self, user_id: int, settings: UserSettingsUpdate) -> UserSettings:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæ›´æ–°"""
        pass
```

#### 4.1.4 FavoriteService ã‚¯ãƒ©ã‚¹
```python
class FavoriteService:
    """ãŠæ°—ã«å…¥ã‚Šç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, favorite_repository: UserFavoriteRepository,
                 game_repository: GameRepository):
        self.favorite_repository = favorite_repository
        self.game_repository = game_repository
    
    async def add_favorite(self, user_id: int, game_id: int, 
                          price_threshold: Optional[float] = None) -> UserFavorite:
        """ãŠæ°—ã«å…¥ã‚Šè¿½åŠ """
        pass
    
    async def remove_favorite(self, user_id: int, game_id: int) -> bool:
        """ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤"""
        pass
    
    async def get_user_favorites(self, user_id: int) -> List[FavoriteGame]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠæ°—ã«å…¥ã‚Šä¸€è¦§å–å¾—"""
        pass
```

#### 4.1.5 NotificationService ã‚¯ãƒ©ã‚¹
```python
class NotificationService:
    """é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹"""
    
    def __init__(self, notification_repository: NotificationRepository,
                 discord_bot: DiscordBot,
                 user_repository: UserRepository):
        self.notification_repository = notification_repository
        self.discord_bot = discord_bot
        self.user_repository = user_repository
    
    async def create_price_notification(self, user_id: int, game_id: int,
                                       notification_type: str, price_data: dict) -> Notification:
        """ä¾¡æ ¼é€šçŸ¥ä½œæˆ"""
        pass
    
    async def send_discord_notification(self, notification: Notification) -> bool:
        """Discordé€šçŸ¥é€ä¿¡"""
        pass
    
    async def process_pending_notifications(self) -> None:
        """æœªé€ä¿¡é€šçŸ¥å‡¦ç†"""
        pass
```

### 4.2 ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‚¯ãƒ©ã‚¹

#### 4.2.1 BaseRepository ã‚¯ãƒ©ã‚¹
```python
from abc import ABC, abstractmethod
from typing import Generic, TypeVar, Optional, List

T = TypeVar('T')

class BaseRepository(Generic[T], ABC):
    """ãƒªãƒã‚¸ãƒˆãƒªåŸºåº•ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, db_session):
        self.db = db_session
    
    @abstractmethod
    async def get_by_id(self, id: int) -> Optional[T]:
        pass
    
    @abstractmethod
    async def create(self, entity: T) -> T:
        pass
    
    @abstractmethod
    async def update(self, entity: T) -> T:
        pass
    
    @abstractmethod
    async def delete(self, id: int) -> bool:
        pass
```

#### 4.2.2 GameRepository ã‚¯ãƒ©ã‚¹
```python
class GameRepository(BaseRepository[Game]):
    """ã‚²ãƒ¼ãƒ ãƒªãƒã‚¸ãƒˆãƒª"""
    
    async def find_by_title(self, title: str) -> List[Game]:
        """ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢"""
        pass
    
    async def find_by_steam_app_id(self, app_id: str) -> Optional[Game]:
        """Steam App IDæ¤œç´¢"""
        pass
    
    async def search_games(self, query: str, filters: SearchFilters) -> List[Game]:
        """ã‚²ãƒ¼ãƒ æ¤œç´¢"""
        pass
```

### 4.3 å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

#### 4.3.1 BaseAPIClient ã‚¯ãƒ©ã‚¹
```python
class BaseAPIClient(ABC):
    """å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåŸºåº•ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, base_url: str, rate_limiter: RateLimiter):
        self.base_url = base_url
        self.rate_limiter = rate_limiter
        self.session = httpx.AsyncClient()
    
    @abstractmethod
    async def search_games(self, query: str) -> List[dict]:
        pass
    
    async def _make_request(self, method: str, endpoint: str, **kwargs) -> dict:
        """HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ"""
        pass
```

#### 4.3.2 SteamAPIClient ã‚¯ãƒ©ã‚¹
```python
class SteamAPIClient(BaseAPIClient):
    """Steam API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"""
    
    def __init__(self, api_key: str):
        super().__init__("https://store.steampowered.com/api", 
                        RateLimiter(rate=10, per=1))
        self.api_key = api_key
    
    async def search_games(self, query: str) -> List[SteamGame]:
        """Steam ã‚²ãƒ¼ãƒ æ¤œç´¢"""
        pass
    
    async def get_app_details(self, app_id: str) -> Optional[SteamGameDetail]:
        """Steam ã‚¢ãƒ—ãƒªè©³ç´°å–å¾—"""
        pass
```

### 4.4 ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

#### 4.4.1 User ãƒ¢ãƒ‡ãƒ«
```python
from sqlalchemy import Column, Integer, String, Boolean, DateTime, Text
from datetime import datetime

class User(BaseModel):
    __tablename__ = 'users'
    
    user_id = Column(Integer, primary_key=True)
    discord_id = Column(String(20), unique=True, nullable=False)
    username = Column(String(100), nullable=False)
    avatar_url = Column(String(255))
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    favorites = relationship("UserFavorite", back_populates="user")
    settings = relationship("UserSettings", uselist=False, back_populates="user")
```

#### 4.4.2 Game ãƒ¢ãƒ‡ãƒ«
```python
class Game(BaseModel):
    __tablename__ = 'games'
    
    game_id = Column(Integer, primary_key=True)
    title = Column(String(200), nullable=False)
    normalized_title = Column(String(200), nullable=False)
    steam_app_id = Column(String(20), unique=True)
    epic_game_id = Column(String(50))
    image_url = Column(String(255))
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    prices = relationship("Price", back_populates="game")
    price_history = relationship("PriceHistory", back_populates="game")
    favorites = relationship("UserFavorite", back_populates="game")
```

### 4.5 Discord Bot ã‚¯ãƒ©ã‚¹

#### 4.5.1 DiscordBot ã‚¯ãƒ©ã‚¹
```python
import discord
from discord.ext import commands

class DiscordBot:
    """Discord Bot ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self, token: str, game_service: GameService, 
                 price_service: PriceService):
        self.bot = commands.Bot(command_prefix='!gb ', intents=discord.Intents.all())
        self.game_service = game_service
        self.price_service = price_service
        
        self._setup_commands()
    
    def _setup_commands(self):
        """ã‚³ãƒãƒ³ãƒ‰è¨­å®š"""
        
        @self.bot.command(name='search')
        async def search_games(ctx, *, query: str):
            """ã‚²ãƒ¼ãƒ æ¤œç´¢ã‚³ãƒãƒ³ãƒ‰"""
            pass
        
        @self.bot.command(name='price')
        async def get_price(ctx, *, game_title: str):
            """ä¾¡æ ¼ç¢ºèªã‚³ãƒãƒ³ãƒ‰"""
            pass
    
    async def send_notification(self, user_discord_id: str, message: str) -> bool:
        """é€šçŸ¥é€ä¿¡"""
        pass
    
    async def start(self):
        """Boté–‹å§‹"""
        await self.bot.start(self.token)
```

### 4.6 ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹

#### 4.6.1 RateLimiter ã‚¯ãƒ©ã‚¹
```python
import asyncio
from datetime import datetime, timedelta

class RateLimiter:
    """ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç®¡ç†"""
    
    def __init__(self, rate: int, per: float):
        self.rate = rate  # è¨±å¯å›æ•°
        self.per = per    # æœŸé–“ï¼ˆç§’ï¼‰
        self.calls = []
    
    async def __aenter__(self):
        """éåŒæœŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å…¥å£"""
        now = datetime.utcnow()
        # å¤ã„ã‚³ãƒ¼ãƒ«è¨˜éŒ²ã‚’å‰Šé™¤
        self.calls = [call_time for call_time in self.calls 
                     if now - call_time < timedelta(seconds=self.per)]
        
        if len(self.calls) >= self.rate:
            sleep_time = self.per - (now - self.calls[0]).total_seconds()
            if sleep_time > 0:
                await asyncio.sleep(sleep_time)
        
        self.calls.append(now)
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """éåŒæœŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å‡ºå£"""
        pass
```

---

## 5. APIè©³ç´°è¨­è¨ˆ

### 4.1 RESTful API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### 4.1.1 ã‚²ãƒ¼ãƒ é–¢é€£API
```
GET /api/v1/games/search
  Query Parameters:
    - q: string (required) - æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    - limit: integer (optional, default=20) - çµæœæ•°åˆ¶é™
    - offset: integer (optional, default=0) - ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    - store: string (optional) - ã‚¹ãƒˆã‚¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ('steam', 'epic', 'all')
    - genre: string (optional) - ã‚¸ãƒ£ãƒ³ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    - max_price: number (optional) - æœ€å¤§ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  Response: GameSearchResponse

GET /api/v1/games/{game_id}
  Path Parameters:
    - game_id: integer (required)
  Response: GameDetailResponse

GET /api/v1/games/{game_id}/prices
  Path Parameters:
    - game_id: integer (required)
  Query Parameters:
    - days: integer (optional, default=30) - ä¾¡æ ¼å±¥æ­´æœŸé–“
  Response: PriceHistoryResponse
```

#### 4.1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£API
```
GET /api/v1/user/profile
  Headers: Authorization: Bearer {token}
  Response: UserProfileResponse

PUT /api/v1/user/profile
  Headers: Authorization: Bearer {token}
  Request Body: UserProfileUpdateRequest
  Response: UserProfileResponse

GET /api/v1/user/favorites
  Headers: Authorization: Bearer {token}
  Response: UserFavoritesResponse

POST /api/v1/user/favorites
  Headers: Authorization: Bearer {token}
  Request Body: AddFavoriteRequest
  Response: FavoriteResponse

DELETE /api/v1/user/favorites/{game_id}
  Headers: Authorization: Bearer {token}
  Path Parameters:
    - game_id: integer (required)
  Response: SuccessResponse
```

### 4.2 APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹å®šç¾©

#### 4.2.1 å…±é€šãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
```python
from typing import Optional, List, Any
from pydantic import BaseModel
from datetime import datetime

class BaseResponse(BaseModel):
    success: bool
    message: Optional[str] = None
    timestamp: datetime

class ErrorResponse(BaseResponse):
    error_code: str
    details: Optional[dict] = None

class PaginatedResponse(BaseResponse):
    data: List[Any]
    pagination: dict  # {total, limit, offset, has_next, has_prev}
```

#### 4.2.2 ã‚²ãƒ¼ãƒ é–¢é€£ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
```python
class PriceInfo(BaseModel):
    store: str
    regular_price: Optional[float]
    sale_price: Optional[float]
    discount_rate: int
    is_on_sale: bool
    store_url: str

class GameBasic(BaseModel):
    game_id: int
    title: str
    developer: Optional[str]
    image_url: Optional[str]
    current_prices: List[PriceInfo]
    lowest_price: Optional[PriceInfo]

class GameDetail(GameBasic):
    publisher: Optional[str]
    description: Optional[str]
    genres: List[str]
    release_date: Optional[str]
    steam_rating: Optional[float]
    metacritic_score: Optional[int]

class GameSearchResponse(PaginatedResponse):
    data: List[GameBasic]

class GameDetailResponse(BaseResponse):
    data: GameDetail
```

---

## 6. æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ

### 6.1 F001: ã‚²ãƒ¼ãƒ æ¤œç´¢æ©Ÿèƒ½

#### 6.1.1 å‡¦ç†ãƒ•ãƒ­ãƒ¼
![F001 ã‚²ãƒ¼ãƒ æ¤œç´¢æ©Ÿèƒ½ãƒ•ãƒ­ãƒ¼](F001_ã‚²ãƒ¼ãƒ æ¤œç´¢ãƒ•ãƒ­ãƒ¼.drawio.png)

#### 6.1.2 ã‚¯ãƒ©ã‚¹è¨­è¨ˆ
```python
class GameSearchService:
    def __init__(self, steam_client: SteamAPIClient, epic_client: EpicAPIClient, 
                 game_repository: GameRepository):
        self.steam_client = steam_client
        self.epic_client = epic_client
        self.game_repository = game_repository
    
    async def search_games(self, query: str, filters: SearchFilters) -> SearchResult:
        """ã‚²ãƒ¼ãƒ æ¤œç´¢ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
        # 1. å…¥åŠ›å€¤æ¤œè¨¼
        self._validate_search_query(query)
        
        # 2. ãƒ­ãƒ¼ã‚«ãƒ«DBæ¤œç´¢
        local_results = await self._search_local_games(query, filters)
        
        # 3. å¤–éƒ¨APIæ¤œç´¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        if self._should_search_external(local_results, query):
            external_results = await self._search_external_apis(query, filters)
            # 4. çµæœçµ±åˆãƒ»é‡è¤‡é™¤å»
            merged_results = self._merge_results(local_results, external_results)
        else:
            merged_results = local_results
        
        # 5. ä¾¡æ ¼æƒ…å ±ä»˜ä¸
        enriched_results = await self._enrich_with_prices(merged_results)
        
        # 6. ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        final_results = self._apply_filters_and_sort(enriched_results, filters)
        
        return final_results
```

#### 5.1.3 å…¥åŠ›å€¤æ¤œè¨¼
```python
class SearchValidator:
    MIN_QUERY_LENGTH = 2
    MAX_QUERY_LENGTH = 100
    
    @staticmethod
    def validate_search_query(query: str) -> None:
        if not query or not query.strip():
            raise ValidationError("æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        if len(query.strip()) < SearchValidator.MIN_QUERY_LENGTH:
            raise ValidationError(f"æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{SearchValidator.MIN_QUERY_LENGTH}æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„")
        
        if len(query.strip()) > SearchValidator.MAX_QUERY_LENGTH:
            raise ValidationError(f"æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{SearchValidator.MAX_QUERY_LENGTH}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
        
        # ç‰¹æ®Šæ–‡å­—ãƒã‚§ãƒƒã‚¯
        if not re.match(r'^[a-zA-Z0-9\s\-\.\'\:]+$', query):
            raise ValidationError("ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™")
```

#### 5.1.4 å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…

```python
# Steam API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
class SteamAPIClient:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://store.steampowered.com/api"
        self.rate_limiter = RateLimiter(rate=10, per=1)  # 10 requests per second
    
    async def search_games(self, query: str) -> List[SteamGame]:
        """Steam ã‚²ãƒ¼ãƒ æ¤œç´¢"""
        async with self.rate_limiter:
            url = f"{self.base_url}/storesearch/"
            params = {
                'term': query,
                'l': 'japanese',
                'cc': 'JP'
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url, params=params)
                data = response.json()
                
                return [SteamGame.from_api_data(item) for item in data.get('items', [])]
    
    async def get_app_details(self, app_id: str) -> Optional[SteamGameDetail]:
        """Steam ã‚¢ãƒ—ãƒªè©³ç´°å–å¾—"""
        async with self.rate_limiter:
            url = f"{self.base_url}/appdetails/"
            params = {
                'appids': app_id,
                'cc': 'JP',
                'l': 'japanese'
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url, params=params)
                data = response.json()
                
                if data.get(app_id, {}).get('success'):
                    return SteamGameDetail.from_api_data(data[app_id]['data'])
                return None

# Epic Games API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
class EpicAPIClient:
    def __init__(self):
        self.base_url = "https://store-site-backend-static.ak.epicgames.com"
        self.rate_limiter = RateLimiter(rate=5, per=1)  # 5 requests per second
    
    async def search_games(self, query: str) -> List[EpicGame]:
        """Epic Games ã‚¹ãƒˆã‚¢æ¤œç´¢"""
        async with self.rate_limiter:
            url = f"{self.base_url}/freeGamesPromotions"
            params = {
                'locale': 'ja',
                'country': 'JP'
            }
            
            async with httpx.AsyncClient() as client:
                # Epic ã®æ¤œç´¢APIã¯é™å®šçš„ãªã®ã§ã€ã‚«ã‚¿ãƒ­ã‚°å…¨ä½“ã‹ã‚‰æ¤œç´¢
                response = await client.get(url, params=params)
                data = response.json()
                
                games = []
                for element in data.get('data', {}).get('Catalog', {}).get('searchStore', {}).get('elements', []):
                    if query.lower() in element.get('title', '').lower():
                        games.append(EpicGame.from_api_data(element))
                
                return games
    
    async def get_game_details(self, namespace: str, slug: str) -> Optional[EpicGameDetail]:
        """Epic Games ã‚²ãƒ¼ãƒ è©³ç´°å–å¾—"""
        async with self.rate_limiter:
            url = f"{self.base_url}/freeGamesPromotions"
            params = {
                'locale': 'ja',
                'country': 'JP'
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url, params=params)
                data = response.json()
                
                # ç‰¹å®šã®ã‚²ãƒ¼ãƒ ã‚’æ¢ã™
                for element in data.get('data', {}).get('Catalog', {}).get('searchStore', {}).get('elements', []):
                    if element.get('catalogNs', {}).get('mappings', [{}])[0].get('pageSlug') == slug:
                        return EpicGameDetail.from_api_data(element)
                
                return None

# ä¾¡æ ¼æ¯”è¼ƒã‚µãƒ¼ãƒ“ã‚¹ã®å¼·åŒ–
class EnhancedPriceComparisonService(PriceComparisonService):
    def __init__(self, price_repository: PriceRepository, 
                 steam_client: SteamAPIClient, epic_client: EpicAPIClient):
        super().__init__(price_repository)
        self.steam_client = steam_client
        self.epic_client = epic_client
    
    async def get_real_time_prices(self, game_id: int) -> PriceComparison:
        """ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼æ¯”è¼ƒï¼ˆPhase 1 å®Ÿè£…ï¼‰"""
        game = await self.game_repository.get_by_id(game_id)
        if not game:
            raise GameNotFoundError(f"Game not found: {game_id}")
        
        # ä¸¦åˆ—ã§ä¸¡ã‚¹ãƒˆã‚¢ã®ä¾¡æ ¼ã‚’å–å¾—
        steam_price_task = self._get_steam_price(game.steam_app_id) if game.steam_app_id else None
        epic_price_task = self._get_epic_price(game.epic_game_id) if game.epic_game_id else None
        
        prices = []
        
        if steam_price_task:
            steam_price = await steam_price_task
            if steam_price:
                prices.append(steam_price)
        
        if epic_price_task:
            epic_price = await epic_price_task
            if epic_price:
                prices.append(epic_price)
        
        # æœ€å®‰å€¤åˆ¤å®š
        cheapest = self._find_cheapest_price(prices) if prices else None
        
        return PriceComparison(
            game_id=game_id,
            prices=prices,
            cheapest=cheapest,
            discount_info=self._calculate_discounts(prices),
            last_updated=datetime.utcnow(),
            real_time=True  # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—ãƒ•ãƒ©ã‚°
        )
    
    async def _get_steam_price(self, app_id: str) -> Optional[PriceInfo]:
        """Steam ä¾¡æ ¼å–å¾—"""
        try:
            details = await self.steam_client.get_app_details(app_id)
            if details and details.price_overview:
                return PriceInfo(
                    store='steam',
                    regular_price=details.price_overview.initial / 100,
                    sale_price=details.price_overview.final / 100 if details.price_overview.discount_percent > 0 else None,
                    discount_rate=details.price_overview.discount_percent,
                    is_on_sale=details.price_overview.discount_percent > 0,
                    store_url=f"https://store.steampowered.com/app/{app_id}/",
                    currency=details.price_overview.currency
                )
        except Exception as e:
            logger.error(f"Failed to get Steam price for {app_id}: {e}")
        return None
    
    async def _get_epic_price(self, game_id: str) -> Optional[PriceInfo]:
        """Epic Games ä¾¡æ ¼å–å¾—"""
        try:
            # Epic ã®ä¾¡æ ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡ç•¥åŒ–ï¼‰
            # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚ˆã‚Šè©³ç´°ãªAPIå‘¼ã³å‡ºã—ãŒå¿…è¦
            details = await self.epic_client.get_game_details(game_id)
            if details and details.price:
                return PriceInfo(
                    store='epic',
                    regular_price=details.price.original_price,
                    sale_price=details.price.discounted_price if details.price.discount_percentage > 0 else None,
                    discount_rate=details.price.discount_percentage,
                    is_on_sale=details.price.discount_percentage > 0,
                    store_url=f"https://store.epicgames.com/ja/p/{game_id}",
                    currency='JPY'
                )
        except Exception as e:
            logger.error(f"Failed to get Epic price for {game_id}: {e}")
        return None
```
```python
class GameSearchService:
    def __init__(self, steam_client: SteamAPIClient, epic_client: EpicAPIClient, 
                 game_repository: GameRepository):
        self.steam_client = steam_client
        self.epic_client = epic_client
        self.game_repository = game_repository
    
    async def search_games(self, query: str, filters: SearchFilters) -> SearchResult:
        """ã‚²ãƒ¼ãƒ æ¤œç´¢ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
        # 1. å…¥åŠ›å€¤æ¤œè¨¼
        self._validate_search_query(query)
        
        # 2. ãƒ­ãƒ¼ã‚«ãƒ«DBæ¤œç´¢
        local_results = await self._search_local_games(query, filters)
        
        # 3. å¤–éƒ¨APIæ¤œç´¢ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        if self._should_search_external(local_results, query):
            external_results = await self._search_external_apis(query, filters)
            # 4. çµæœçµ±åˆãƒ»é‡è¤‡é™¤å»
            merged_results = self._merge_results(local_results, external_results)
        else:
            merged_results = local_results
        
        # 5. ä¾¡æ ¼æƒ…å ±ä»˜ä¸
        enriched_results = await self._enrich_with_prices(merged_results)
        
        # 6. ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        final_results = self._apply_filters_and_sort(enriched_results, filters)
        
        return final_results
```

#### 5.1.3 å…¥åŠ›å€¤æ¤œè¨¼
```python
class SearchValidator:
    MIN_QUERY_LENGTH = 2
    MAX_QUERY_LENGTH = 100
    
    @staticmethod
    def validate_search_query(query: str) -> None:
        if not query or not query.strip():
            raise ValidationError("æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        if len(query.strip()) < SearchValidator.MIN_QUERY_LENGTH:
            raise ValidationError(f"æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{SearchValidator.MIN_QUERY_LENGTH}æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„")
        
        if len(query.strip()) > SearchValidator.MAX_QUERY_LENGTH:
            raise ValidationError(f"æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯{SearchValidator.MAX_QUERY_LENGTH}æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
        
        # ç‰¹æ®Šæ–‡å­—ãƒã‚§ãƒƒã‚¯
        if not re.match(r'^[a-zA-Z0-9\s\-\.\'\:]+$', query):
            raise ValidationError("ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™")
```

#### 5.1.4 å¤–éƒ¨API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…

```python
# Steam API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
class SteamAPIClient:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://store.steampowered.com/api"
        self.rate_limiter = RateLimiter(rate=10, per=1)  # 10 requests per second
    
    async def search_games(self, query: str) -> List[SteamGame]:
        """Steam ã‚²ãƒ¼ãƒ æ¤œç´¢"""
        async with self.rate_limiter:
            url = f"{self.base_url}/storesearch/"
            params = {
                'term': query,
                'l': 'japanese',
                'cc': 'JP'
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url, params=params)
                data = response.json()
                
                return [SteamGame.from_api_data(item) for item in data.get('items', [])]
    
    async def get_app_details(self, app_id: str) -> Optional[SteamGameDetail]:
        """Steam ã‚¢ãƒ—ãƒªè©³ç´°å–å¾—"""
        async with self.rate_limiter:
            url = f"{self.base_url}/appdetails/"
            params = {
                'appids': app_id,
                'cc': 'JP',
                'l': 'japanese'
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url, params=params)
                data = response.json()
                
                if data.get(app_id, {}).get('success'):
                    return SteamGameDetail.from_api_data(data[app_id]['data'])
                return None

# Epic Games API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
class EpicAPIClient:
    def __init__(self):
        self.base_url = "https://store-site-backend-static.ak.epicgames.com"
        self.rate_limiter = RateLimiter(rate=5, per=1)  # 5 requests per second
    
    async def search_games(self, query: str) -> List[EpicGame]:
        """Epic Games ã‚¹ãƒˆã‚¢æ¤œç´¢"""
        async with self.rate_limiter:
            url = f"{self.base_url}/freeGamesPromotions"
            params = {
                'locale': 'ja',
                'country': 'JP'
            }
            
            async with httpx.AsyncClient() as client:
                # Epic ã®æ¤œç´¢APIã¯é™å®šçš„ãªã®ã§ã€ã‚«ã‚¿ãƒ­ã‚°å…¨ä½“ã‹ã‚‰æ¤œç´¢
                response = await client.get(url, params=params)
                data = response.json()
                
                games = []
                for element in data.get('data', {}).get('Catalog', {}).get('searchStore', {}).get('elements', []):
                    if query.lower() in element.get('title', '').lower():
                        games.append(EpicGame.from_api_data(element))
                
                return games
    
    async def get_game_details(self, namespace: str, slug: str) -> Optional[EpicGameDetail]:
        """Epic Games ã‚²ãƒ¼ãƒ è©³ç´°å–å¾—"""
        async with self.rate_limiter:
            url = f"{self.base_url}/freeGamesPromotions"
            params = {
                'locale': 'ja',
                'country': 'JP'
            }
            
            async with httpx.AsyncClient() as client:
                response = await client.get(url, params=params)
                data = response.json()
                
                # ç‰¹å®šã®ã‚²ãƒ¼ãƒ ã‚’æ¢ã™
                for element in data.get('data', {}).get('Catalog', {}).get('searchStore', {}).get('elements', []):
                    if element.get('catalogNs', {}).get('mappings', [{}])[0].get('pageSlug') == slug:
                        return EpicGameDetail.from_api_data(element)
                
                return None

# ä¾¡æ ¼æ¯”è¼ƒã‚µãƒ¼ãƒ“ã‚¹ã®å¼·åŒ–
class EnhancedPriceComparisonService(PriceComparisonService):
    def __init__(self, price_repository: PriceRepository, 
                 steam_client: SteamAPIClient, epic_client: EpicAPIClient):
        super().__init__(price_repository)
        self.steam_client = steam_client
        self.epic_client = epic_client
    
    async def get_real_time_prices(self, game_id: int) -> PriceComparison:
        """ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¾¡æ ¼æ¯”è¼ƒï¼ˆPhase 1 å®Ÿè£…ï¼‰"""
        game = await self.game_repository.get_by_id(game_id)
        if not game:
            raise GameNotFoundError(f"Game not found: {game_id}")
        
        # ä¸¦åˆ—ã§ä¸¡ã‚¹ãƒˆã‚¢ã®ä¾¡æ ¼ã‚’å–å¾—
        steam_price_task = self._get_steam_price(game.steam_app_id) if game.steam_app_id else None
        epic_price_task = self._get_epic_price(game.epic_game_id) if game.epic_game_id else None
        
        prices = []
        
        if steam_price_task:
            steam_price = await steam_price_task
            if steam_price:
                prices.append(steam_price)
        
        if epic_price_task:
            epic_price = await epic_price_task
            if epic_price:
                prices.append(epic_price)
        
        # æœ€å®‰å€¤åˆ¤å®š
        cheapest = self._find_cheapest_price(prices) if prices else None
        
        return PriceComparison(
            game_id=game_id,
            prices=prices,
            cheapest=cheapest,
            discount_info=self._calculate_discounts(prices),
            last_updated=datetime.utcnow(),
            real_time=True  # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾—ãƒ•ãƒ©ã‚°
        )
    
    async def _get_steam_price(self, app_id: str) -> Optional[PriceInfo]:
        """Steam ä¾¡æ ¼å–å¾—"""
        try:
            details = await self.steam_client.get_app_details(app_id)
            if details and details.price_overview:
                return PriceInfo(
                    store='steam',
                    regular_price=details.price_overview.initial / 100,
                    sale_price=details.price_overview.final / 100 if details.price_overview.discount_percent > 0 else None,
                    discount_rate=details.price_overview.discount_percent,
                    is_on_sale=details.price_overview.discount_percent > 0,
                    store_url=f"https://store.steampowered.com/app/{app_id}/",
                    currency=details.price_overview.currency
                )
        except Exception as e:
            logger.error(f"Failed to get Steam price for {app_id}: {e}")
        return None
    
    async def _get_epic_price(self, game_id: str) -> Optional[PriceInfo]:
        """Epic Games ä¾¡æ ¼å–å¾—"""
        try:
            # Epic ã®ä¾¡æ ¼å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡ç•¥åŒ–ï¼‰
            # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã‚ˆã‚Šè©³ç´°ãªAPIå‘¼ã³å‡ºã—ãŒå¿…è¦
            details = await self.epic_client.get_game_details(game_id)
            if details and details.price:
                return PriceInfo(
                    store='epic',
                    regular_price=details.price.original_price,
                    sale_price=details.price.discounted_price if details.price.discount_percentage > 0 else None,
                    discount_rate=details.price.discount_percentage,
                    is_on_sale=details.price.discount_percentage > 0,
                    store_url=f"https://store.epicgames.com/ja/p/{game_id}",
                    currency='JPY'
                )
        except Exception as e:
            logger.error(f"Failed to get Epic price for {game_id}: {e}")
        return None
```

### 6.2 F002: ä¾¡æ ¼æ¯”è¼ƒæ©Ÿèƒ½

#### 6.2.1 å‡¦ç†ãƒ•ãƒ­ãƒ¼
![F002 ä¾¡æ ¼æ¯”è¼ƒæ©Ÿèƒ½ãƒ•ãƒ­ãƒ¼](F002_ä¾¡æ ¼æ¯”è¼ƒãƒ•ãƒ­ãƒ¼.drawio.png)

#### 6.2.2 ä¾¡æ ¼æ¯”è¼ƒãƒ­ã‚¸ãƒƒã‚¯
```python
class PriceComparisonService:
    def __init__(self, price_repository: PriceRepository):
        self.price_repository = price_repository
    
    async def compare_prices(self, game_id: int) -> PriceComparison:
        """ä¾¡æ ¼æ¯”è¼ƒå‡¦ç†"""
        # 1. æœ€æ–°ä¾¡æ ¼æƒ…å ±å–å¾—
        current_prices = await self.price_repository.get_latest_prices(game_id)
        
        # 2. æœ€å®‰å€¤åˆ¤å®š
        cheapest_price = self._find_cheapest_price(current_prices)
        
        # 3. å‰²å¼•ç‡è¨ˆç®—
        discount_info = self._calculate_discounts(current_prices)
        
        # 4. ã‚¹ãƒˆã‚¢æ¯”è¼ƒçµæœä½œæˆ
        comparison_result = PriceComparison(
            game_id=game_id,
            prices=current_prices,
            cheapest=cheapest_price,
            discount_info=discount_info,
            last_updated=datetime.utcnow()
        )
        
        return comparison_result
    
    def _find_cheapest_price(self, prices: List[PriceInfo]) -> Optional[PriceInfo]:
        """æœ€å®‰å€¤ã‚’è¦‹ã¤ã‘ã‚‹"""
        if not prices:
            return None
        
        # ã‚»ãƒ¼ãƒ«ä¾¡æ ¼å„ªå…ˆã€é€šå¸¸ä¾¡æ ¼ã§æ¯”è¼ƒ
        def get_effective_price(price: PriceInfo) -> float:
            return price.sale_price if price.is_on_sale else price.regular_price
        
        return min(prices, key=get_effective_price)
```

### 6.3 F003: Discordèªè¨¼æ©Ÿèƒ½

#### 6.3.1 OAuth2ãƒ•ãƒ­ãƒ¼
![F003 Discordèªè¨¼ãƒ•ãƒ­ãƒ¼](F003_Discordèªè¨¼ãƒ•ãƒ­ãƒ¼.drawio.png)

#### 6.3.2 èªè¨¼å‡¦ç†å®Ÿè£…
```python
from authlib.integrations.flask_client import OAuth
from flask import session, redirect, url_for, request
import secrets

class DiscordAuthService:
    def __init__(self, app, client_id: str, client_secret: str, redirect_uri: str):
        self.client_id = client_id
        self.client_secret = client_secret
        self.redirect_uri = redirect_uri
        
        # Authlib OAuthè¨­å®š
        self.oauth = OAuth(app)
        self.discord = self.oauth.register(
            name='discord',
            client_id=client_id,
            client_secret=client_secret,
            server_metadata_url='https://discord.com/.well-known/openid_configuration',
            client_kwargs={'scope': 'identify email guilds'}
        )
    
    def get_authorization_url(self) -> str:
        """èªè¨¼URLç”Ÿæˆ"""
        # CSRFå¯¾ç­–ã®ãŸã‚stateã‚’ç”Ÿæˆ
        state = secrets.token_urlsafe(32)
        session['oauth_state'] = state
        
        return self.discord.authorize_redirect(
            redirect_uri=self.redirect_uri,
            state=state
        )
    
    async def handle_callback(self, code: str, state: str) -> DiscordUser:
        """èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†"""
        # Stateæ¤œè¨¼
        if state != session.get('oauth_state'):
            raise AuthenticationError("Invalid state parameter")
        
        # ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
        token = await self.discord.authorize_access_token()
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
        user_info = await self.discord.parse_id_token(token)
        guilds = await self._get_user_guilds(token['access_token'])
        
        # DiscordUserã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        discord_user = DiscordUser(
            discord_id=user_info['sub'],
            username=user_info['preferred_username'],
            discriminator=user_info.get('discriminator'),
            avatar_url=self._get_avatar_url(user_info),
            email=user_info.get('email'),
            guilds=[guild['id'] for guild in guilds]
        )
        
        # ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š
        session['user_id'] = discord_user.discord_id
        session.permanent = True
        
        return discord_user
    
    def _get_avatar_url(self, user_info: dict) -> str:
        """ã‚¢ãƒã‚¿ãƒ¼URLç”Ÿæˆ"""
        if not user_info.get('picture'):
            return f"https://cdn.discordapp.com/embed/avatars/{int(user_info.get('discriminator', '0')) % 5}.png"
        return user_info['picture']
    
    async def _get_user_guilds(self, access_token: str) -> list:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚®ãƒ«ãƒ‰æƒ…å ±å–å¾—"""
        import httpx
        
        headers = {'Authorization': f'Bearer {access_token}'}
        async with httpx.AsyncClient() as client:
            response = await client.get(
                'https://discord.com/api/users/@me/guilds',
                headers=headers
            )
            
        if response.status_code == 200:
            return response.json()
        return []

# Flask-Loginç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ©ã‚¹
from flask_login import UserMixin

class User(UserMixin):
    def __init__(self, user_id: int, discord_id: str, username: str, 
                 avatar_url: str = None, is_active: bool = True):
        self.id = user_id
        self.discord_id = discord_id
        self.username = username
        self.avatar_url = avatar_url
        self._is_active = is_active
    
    def is_active(self):
        return self._is_active
    
    @staticmethod
    def get(user_id: int):
        """Flask-Loginç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—"""
        from models.user import UserRepository
        repo = UserRepository()
        return repo.get_by_id(user_id)
```

### 6.4 F004: ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½

#### 6.4.1 æ©Ÿèƒ½æ¦‚è¦
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚²ãƒ¼ãƒ ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ /å‰Šé™¤
- ä¾¡æ ¼é–¾å€¤è¨­å®šã«ã‚ˆã‚‹é€šçŸ¥ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- Discord Boté€šçŸ¥ã¨ã®é€£æº

#### 6.4.2 ã‚¯ãƒ©ã‚¹è¨­è¨ˆ
```python
class FavoriteService:
    def __init__(self, user_repository: UserRepository, game_repository: GameRepository,
                 favorite_repository: FavoriteRepository):
        self.user_repository = user_repository
        self.game_repository = game_repository
        self.favorite_repository = favorite_repository
    
    async def add_favorite(self, user_id: int, game_id: int, 
                          price_threshold: Optional[Decimal] = None) -> Favorite:
        """ãŠæ°—ã«å…¥ã‚Šè¿½åŠ """
        # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚²ãƒ¼ãƒ å­˜åœ¨ç¢ºèª
        user = await self.user_repository.get_by_id(user_id)
        game = await self.game_repository.get_by_id(game_id)
        
        if not user or not game:
            raise ValidationError("ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        # 2. æ—¢å­˜ã®ãŠæ°—ã«å…¥ã‚Šãƒã‚§ãƒƒã‚¯
        existing = await self.favorite_repository.get_by_user_game(user_id, game_id)
        if existing:
            raise ValidationError("æ—¢ã«ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™")
        
        # 3. ãŠæ°—ã«å…¥ã‚Šä½œæˆ
        favorite = Favorite(
            user_id=user_id,
            game_id=game_id,
            notification_enabled=True,
            price_threshold=price_threshold
        )
        
        return await self.favorite_repository.save(favorite)
    
    async def remove_favorite(self, user_id: int, game_id: int) -> bool:
        """ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤"""
        favorite = await self.favorite_repository.get_by_user_game(user_id, game_id)
        if not favorite:
            raise ValidationError("ãŠæ°—ã«å…¥ã‚ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        return await self.favorite_repository.delete(favorite.favorite_id)
    
    async def get_user_favorites(self, user_id: int) -> List[GameWithFavorite]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãŠæ°—ã«å…¥ã‚Šä¸€è¦§å–å¾—"""
        return await self.favorite_repository.get_user_favorites_with_games(user_id)
    
    async def update_notification_settings(self, user_id: int, game_id: int,
                                         notification_enabled: bool,
                                         price_threshold: Optional[Decimal] = None) -> Favorite:
        """é€šçŸ¥è¨­å®šæ›´æ–°"""
        favorite = await self.favorite_repository.get_by_user_game(user_id, game_id)
        if not favorite:
            raise ValidationError("ãŠæ°—ã«å…¥ã‚ŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        
        favorite.notification_enabled = notification_enabled
        favorite.price_threshold = price_threshold
        
        return await self.favorite_repository.update(favorite)
```

### 6.5 F006: ä¾¡æ ¼ç›£è¦–æ©Ÿèƒ½

#### 6.5.1 æ©Ÿèƒ½æ¦‚è¦
- å®šæœŸçš„ãªä¾¡æ ¼æƒ…å ±å–å¾—ãƒ»æ›´æ–°
- ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥ã¨ãŠæ°—ã«å…¥ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥
- APIåˆ¶é™ã‚’è€ƒæ…®ã—ãŸåŠ¹ç‡çš„ãªãƒãƒƒãƒå‡¦ç†

#### 6.5.2 ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯
```python
class PriceChangeDetector:
    def __init__(self, price_repository: PriceRepository, 
                 notification_service: NotificationService):
        self.price_repository = price_repository
        self.notification_service = notification_service
    
    async def detect_price_changes(self, game_id: int, new_prices: List[PriceInfo]) -> List[PriceChange]:
        """ä¾¡æ ¼å¤‰å‹•æ¤œçŸ¥"""
        # 1. ç¾åœ¨ã®ä¾¡æ ¼å–å¾—
        current_prices = await self.price_repository.get_latest_prices(game_id)
        current_by_store = {p.store: p for p in current_prices}
        
        changes = []
        
        for new_price in new_prices:
            current_price = current_by_store.get(new_price.store)
            
            if not current_price:
                # æ–°ã—ã„ã‚¹ãƒˆã‚¢ä¾¡æ ¼
                changes.append(PriceChange(
                    game_id=game_id,
                    store=new_price.store,
                    change_type='new_price',
                    new_price=new_price.effective_price,
                    previous_price=None
                ))
                continue
            
            # ä¾¡æ ¼å¤‰å‹•ãƒã‚§ãƒƒã‚¯
            if new_price.effective_price != current_price.effective_price:
                change_type = self._determine_change_type(current_price, new_price)
                changes.append(PriceChange(
                    game_id=game_id,
                    store=new_price.store,
                    change_type=change_type,
                    new_price=new_price.effective_price,
                    previous_price=current_price.effective_price,
                    discount_rate=new_price.discount_rate
                ))
            
            # ã‚»ãƒ¼ãƒ«çŠ¶æ…‹å¤‰æ›´ãƒã‚§ãƒƒã‚¯
            if new_price.is_on_sale != current_price.is_on_sale:
                sale_change_type = 'sale_start' if new_price.is_on_sale else 'sale_end'
                changes.append(PriceChange(
                    game_id=game_id,
                    store=new_price.store,
                    change_type=sale_change_type,
                    new_price=new_price.effective_price,
                    previous_price=current_price.effective_price,
                    discount_rate=new_price.discount_rate
                ))
        
        return changes
    
    def _determine_change_type(self, current: PriceInfo, new: PriceInfo) -> str:
        """ä¾¡æ ¼å¤‰å‹•ã‚¿ã‚¤ãƒ—åˆ¤å®š"""
        if new.effective_price < current.effective_price:
            return 'price_decrease'
        elif new.effective_price > current.effective_price:
            return 'price_increase'
        return 'price_unchanged'
    
    async def process_price_changes(self, changes: List[PriceChange]) -> None:
        """ä¾¡æ ¼å¤‰å‹•å‡¦ç†"""
        for change in changes:
            # 1. ä¾¡æ ¼å±¥æ­´ä¿å­˜
            await self.price_repository.save_price_history(change)
            
            # 2. é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
            users_to_notify = await self._get_users_to_notify(change)
            
            # 3. é€šçŸ¥ä½œæˆãƒ»é€ä¿¡
            for user in users_to_notify:
                await self.notification_service.create_price_notification(user, change)
    
    async def _get_users_to_notify(self, change: PriceChange) -> List[User]:
        """é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—"""
        # ãŠæ°—ã«å…¥ã‚Šç™»éŒ² + é€šçŸ¥æœ‰åŠ¹ + ä¾¡æ ¼é–¾å€¤æ¡ä»¶ã‚’æº€ãŸã™ãƒ¦ãƒ¼ã‚¶ãƒ¼
        return await self.price_repository.get_users_for_price_notification(
            game_id=change.game_id,
            new_price=change.new_price,
            change_type=change.change_type
        )
```

#### 6.5.3 ãƒãƒƒãƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ
```python
class PriceMonitoringScheduler:
    def __init__(self, price_service: PriceService):
        self.price_service = price_service
        self.scheduler = AsyncIOScheduler()
    
    def setup_schedules(self):
        """ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š"""
        # æ¯æ™‚0åˆ†: ä¾¡æ ¼æ›´æ–°ï¼ˆãŠæ°—ã«å…¥ã‚Šã‚²ãƒ¼ãƒ å„ªå…ˆï¼‰
        self.scheduler.add_job(
            self.update_favorite_games_prices,
            CronTrigger(minute=0),
            id='update_favorite_prices',
            max_instances=1,
            misfire_grace_time=300  # 5åˆ†ä»¥å†…ã®é…å»¶ã¯è¨±å®¹
        )
        
        # æ¯æ—¥3æ™‚: å…¨ã‚²ãƒ¼ãƒ ä¾¡æ ¼æ›´æ–°
        self.scheduler.add_job(
            self.update_all_games_prices,
            CronTrigger(hour=3, minute=0),
            id='update_all_prices',
            max_instances=1,
            misfire_grace_time=1800  # 30åˆ†ä»¥å†…ã®é…å»¶ã¯è¨±å®¹
        )
        
        # æ¯æ—¥9æ™‚: ãŠã™ã™ã‚ã‚»ãƒ¼ãƒ«æƒ…å ±æ›´æ–°
        self.scheduler.add_job(
            self.update_recommended_sales,
            CronTrigger(hour=9, minute=0),
            id='update_recommendations',
            max_instances=1
        )
    
    async def update_favorite_games_prices(self):
        """ãŠæ°—ã«å…¥ã‚Šã‚²ãƒ¼ãƒ ä¾¡æ ¼æ›´æ–°"""
        try:
            logger.info("Starting favorite games price update")
            
            # ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚²ãƒ¼ãƒ ä¸€è¦§å–å¾—
            favorite_games = await self.price_service.get_favorite_games()
            
            success_count = 0
            error_count = 0
            
            for game in favorite_games:
                try:
                    await self.price_service.update_game_prices(game.game_id)
                    success_count += 1
                    
                    # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–: å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“ã«å¾…æ©Ÿ
                    await asyncio.sleep(0.1)
                    
                except Exception as e:
                    logger.error(f"Failed to update prices for game {game.game_id}: {e}")
                    error_count += 1
            
            logger.info(f"Favorite games price update completed. Success: {success_count}, Error: {error_count}")
            
        except Exception as e:
            logger.error(f"Favorite games price update batch failed: {e}")
            raise
    
    async def update_all_games_prices(self):
        """å…¨ã‚²ãƒ¼ãƒ ä¾¡æ ¼æ›´æ–°ï¼ˆæ—¥æ¬¡ï¼‰"""
        try:
            logger.info("Starting all games price update")
            
            # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚²ãƒ¼ãƒ ä¸€è¦§å–å¾—ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼‰
            page_size = 50
            offset = 0
            total_processed = 0
            
            while True:
                games = await self.price_service.get_active_games(limit=page_size, offset=offset)
                
                if not games:
                    break
                
                for game in games:
                    try:
                        await self.price_service.update_game_prices(game.game_id)
                        total_processed += 1
                        
                        # ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
                        await asyncio.sleep(0.2)  # ã‚ˆã‚Šä¿å®ˆçš„ãªé–“éš”
                        
                    except Exception as e:
                        logger.error(f"Failed to update prices for game {game.game_id}: {e}")
                
                offset += page_size
                
                # é€²æ—ãƒ­ã‚°
                if total_processed % 100 == 0:
                    logger.info(f"Processed {total_processed} games")
            
            logger.info(f"All games price update completed. Total processed: {total_processed}")
            
        except Exception as e:
            logger.error(f"All games price update batch failed: {e}")
            raise
```

### 6.6 é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

#### 6.6.1 é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹
```python
class NotificationService:
    def __init__(self, discord_bot: DiscordBot, user_repository: UserRepository):
        self.discord_bot = discord_bot
        self.user_repository = user_repository
    
    async def create_price_notification(self, user: User, price_change: PriceChange) -> Notification:
        """ä¾¡æ ¼å¤‰å‹•é€šçŸ¥ä½œæˆ"""
        game = await self.game_repository.get_by_id(price_change.game_id)
        
        # é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        message = self._generate_price_notification_message(game, price_change)
        
        notification = Notification(
            user_id=user.user_id,
            game_id=price_change.game_id,
            notification_type=price_change.change_type,
            title=f"{game.title} - ä¾¡æ ¼å¤‰å‹•",
            message=message,
            discord_channel_id=None  # DMã¾ãŸã¯è¨­å®šã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«
        )
        
        # é€šçŸ¥é€ä¿¡
        await self._send_discord_notification(user, notification)
        
        return notification
    
    def _generate_price_notification_message(self, game: Game, change: PriceChange) -> str:
        """é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ"""
        if change.change_type == 'sale_start':
            return (
                f"ğŸ® **ã‚»ãƒ¼ãƒ«é–‹å§‹ï¼**\n"
                f"**{game.title}**\n"
                f"{change.store.title()}: Â¥{change.previous_price:,.0f} â†’ "
                f"Â¥{change.new_price:,.0f} ({change.discount_rate}%OFF)\n"
                f"ğŸ’° ç¯€ç´„é¡: Â¥{change.previous_price - change.new_price:,.0f}"
            )
        elif change.change_type == 'price_decrease':
            return (
                f"ğŸ“‰ **ä¾¡æ ¼ä¸‹è½ï¼**\n"
                f"**{game.title}**\n"
                f"{change.store.title()}: Â¥{change.previous_price:,.0f} â†’ "
                f"Â¥{change.new_price:,.0f}\n"
                f"ğŸ’° ç¯€ç´„é¡: Â¥{change.previous_price - change.new_price:,.0f}"
            )
        elif change.change_type == 'sale_end':
            return (
                f"â° **ã‚»ãƒ¼ãƒ«çµ‚äº†**\n"
                f"**{game.title}**\n"
                f"{change.store.title()}: Â¥{change.previous_price:,.0f} â†’ "
                f"Â¥{change.new_price:,.0f}\n"
                f"ã‚»ãƒ¼ãƒ«ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚"
            )
        
        return f"{game.title}ã®ä¾¡æ ¼ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚"
    
    async def _send_discord_notification(self, user: User, notification: Notification) -> bool:
        """Discordé€šçŸ¥é€ä¿¡"""
        try:
            # Discord ãƒ¦ãƒ¼ã‚¶ãƒ¼DMé€ä¿¡
            discord_user = await self.discord_bot.fetch_user(int(user.discord_id))
            
            embed = discord.Embed(
                title=notification.title,
                description=notification.message,
                color=0x00ff00 if 'ã‚»ãƒ¼ãƒ«' in notification.message else 0x0099ff
            )
            
            await discord_user.send(embed=embed)
            
            # é€ä¿¡æˆåŠŸã‚’DBè¨˜éŒ²
            notification.is_sent = True
            notification.sent_at = datetime.utcnow()
            await self.notification_repository.update(notification)
            
            return True
            
        except discord.NotFound:
            logger.warning(f"Discord user not found: {user.discord_id}")
            return False
        except discord.Forbidden:
            logger.warning(f"Cannot send DM to user: {user.discord_id}")
            return False
        except Exception as e:
            logger.error(f"Failed to send Discord notification: {e}")
            return False
```

---

## 11. å®Ÿè£…è¨ˆç”»ãƒ»å„ªå…ˆåº¦

### 11.1 é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º

#### Phase 1: åŸºç›¤æ©Ÿèƒ½ (1é€±é–“)
**ç›®æ¨™**: åŸºæœ¬çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œã¨ä¾¡æ ¼æ¯”è¼ƒæ©Ÿèƒ½
- **F001**: ã‚²ãƒ¼ãƒ æ¤œç´¢æ©Ÿèƒ½ (Steam + Epic Games API)
- **F002**: ä¾¡æ ¼æ¯”è¼ƒæ©Ÿèƒ½ (Steam vs Epic ä¾¡æ ¼æ¯”è¼ƒ)
- **F003**: Discordèªè¨¼æ©Ÿèƒ½
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- åŸºæœ¬çš„ãªWeb UI 

**å®Œäº†æ¡ä»¶**: 
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒDiscordã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
- ã‚²ãƒ¼ãƒ æ¤œç´¢ãƒ»ä¾¡æ ¼è¡¨ç¤ºãŒå‹•ä½œ
- **Steam ã¨ Epic ã®ä¾¡æ ¼æ¯”è¼ƒãŒå‹•ä½œ**
- åŸºæœ¬çš„ãªç”»é¢é·ç§»ãŒå®Œæˆ

**ã‚¹ã‚³ãƒ¼ãƒ—èª¿æ•´**:
- UI ã¯æœ€å°é™ï¼ˆè£…é£¾ã‚ˆã‚Šæ©Ÿèƒ½å„ªå…ˆï¼‰
- **Steam API ã¨ Epic Games API ä¸¡æ–¹å¯¾å¿œ**
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯åŸºæœ¬çš„ãªã‚‚ã®ã®ã¿
- ä¾¡æ ¼æ¯”è¼ƒçµæœã®è¦–è¦šçš„è¡¨ç¤ºï¼ˆæœ€å®‰å€¤ãƒã‚¤ãƒ©ã‚¤ãƒˆç­‰ï¼‰

#### Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ (1é€±é–“)
**ç›®æ¨™**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹åˆ¥æ©Ÿèƒ½ã®å®Ÿè£…
- **F004**: ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ï¼ˆä¾¡æ ¼é–¾å€¤è¨­å®šå«ã‚€ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒšãƒ¼ã‚¸ãƒ»è¨­å®šç”»é¢ï¼ˆæœ€å°é™ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å®‰å®šåŒ–

**å®Œäº†æ¡ä»¶**:
- ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ãƒ»å‰Šé™¤ãŒå‹•ä½œ
- **ä¾¡æ ¼é–¾å€¤è¨­å®šã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
- èªè¨¼çŠ¶æ…‹ã®ç¶­æŒ

**ã‚¹ã‚³ãƒ¼ãƒ—èª¿æ•´**:
- è¨­å®šé …ç›®ã¯é€šçŸ¥ON/OFF ã¨ä¾¡æ ¼é–¾å€¤
- **ä¾¡æ ¼é–¾å€¤è¨­å®šã‚’ Phase 2 ã§å®Ÿè£…**ï¼ˆPhase 4 ã‹ã‚‰å‰å€’ã—ï¼‰

#### Phase 3: Discord Bot (1é€±é–“)
**ç›®æ¨™**: Discord Botæ©Ÿèƒ½ã®å®Ÿè£…
- **F005**: Discord BotåŸºæœ¬æ©Ÿèƒ½
- ã‚²ãƒ¼ãƒ æ¤œç´¢ãƒ»ä¾¡æ ¼ç¢ºèªã‚³ãƒãƒ³ãƒ‰
- Webã‚¢ãƒ—ãƒªã¨Botã®çµ±åˆ

**å®Œäº†æ¡ä»¶**:
- Discord Bot ãŒã‚³ãƒãƒ³ãƒ‰ã«å¿œç­”
- Webã‚¢ãƒ—ãƒªã¨DBãƒ»ãƒ­ã‚¸ãƒƒã‚¯å…±æœ‰
- Botæ‹›å¾…ãƒ»è¨­å®šãŒå¯èƒ½

**ã‚¹ã‚³ãƒ¼ãƒ—èª¿æ•´**:
- ã‚³ãƒãƒ³ãƒ‰ã¯æ¤œç´¢ãƒ»ä¾¡æ ¼ç¢ºèªã®ã¿
- é«˜åº¦ãªã‚³ãƒãƒ³ãƒ‰ï¼ˆçµ±è¨ˆãªã©ï¼‰ã¯å¾Œå›ã—

#### Phase 4: ä¾¡æ ¼ç›£è¦–ãƒ»é€šçŸ¥ (1é€±é–“)
**ç›®æ¨™**: è‡ªå‹•åŒ–ãƒ»é€šçŸ¥æ©Ÿèƒ½ã®å®Œæˆ
- **F006**: ä¾¡æ ¼ç›£è¦–ãƒãƒƒãƒæ©Ÿèƒ½
- é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  (Discord DM)
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- å“è³ªå‘ä¸Šãƒ»é‹ç”¨æº–å‚™

**å®Œäº†æ¡ä»¶**:
- ä¾¡æ ¼å¤‰å‹•ã®è‡ªå‹•æ¤œçŸ¥
- ãŠæ°—ã«å…¥ã‚Šã‚²ãƒ¼ãƒ ã®é€šçŸ¥
- å®‰å®šã—ãŸãƒãƒƒãƒå‡¦ç†
- æœ¬ç•ªé‹ç”¨å¯èƒ½ãªå“è³ª

**ã‚¹ã‚³ãƒ¼ãƒ—èª¿æ•´**:
- Phase 5ã‚’çµ±åˆã—ã€å¿…è¦æœ€å°é™ã®é‹ç”¨å“è³ªã‚’ç¢ºä¿
- è¤‡é›‘ãªä¾¡æ ¼äºˆæ¸¬æ©Ÿèƒ½ã¯å°†æ¥æ‹¡å¼µã¨ã™ã‚‹
- ãƒ­ã‚°ãƒ»ç›£è¦–ã¯åŸºæœ¬çš„ãªã‚‚ã®ã®ã¿
- **Epic Games API å¯¾å¿œã¯ Phase 1 ã§å®Œäº†æ¸ˆã¿**

### 11.2 æŠ€è¡“çš„èª²é¡Œã¨å¯¾ç­–

#### é«˜å„ªå…ˆåº¦èª²é¡Œ
1. **APIåˆ¶é™å¯¾å¿œ**
   - èª²é¡Œ: Steam/Epic APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™
   - å¯¾ç­–: é©åˆ‡ãªé–“éš”åˆ¶å¾¡ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

2. **ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿å“è³ª**
   - èª²é¡Œ: å¤–éƒ¨APIãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆãƒ»æ¬ æ
   - å¯¾ç­–: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã€è¤‡æ•°ã‚½ãƒ¼ã‚¹ç…§åˆã€æ‰‹å‹•è£œæ­£æ©Ÿèƒ½

3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
   - èª²é¡Œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼å¢—åŠ æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
   - å¯¾ç­–: åŠ¹ç‡çš„ãªDBè¨­è¨ˆã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã€ãƒãƒƒãƒå‡¦ç†æœ€é©åŒ–

#### ä¸­å„ªå…ˆåº¦èª²é¡Œ
1. **Discord Botå®‰å®šæ€§**
   - èª²é¡Œ: Botæ¥ç¶šåˆ‡æ–­ã€ã‚³ãƒãƒ³ãƒ‰å¿œç­”æ€§
   - å¯¾ç­–: å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã€ã‚¨ãƒ©ãƒ¼é€šçŸ¥

2. **èªè¨¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - èª²é¡Œ: OAuth ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å®‰å…¨æ€§
   - å¯¾ç­–: ãƒˆãƒ¼ã‚¯ãƒ³æš—å·åŒ–ã€é©åˆ‡ãªæœ‰åŠ¹æœŸé™ã€CSRFå¯¾ç­–

### 11.3 é‹ç”¨ãƒ»ä¿å®ˆè¨ˆç”»

#### å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
- **æ—¥æ¬¡**: ãƒãƒƒãƒå‡¦ç†ãƒ­ã‚°ç¢ºèªã€APIæˆåŠŸç‡ç¢ºèª
- **é€±æ¬¡**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
- **æœˆæ¬¡**: å¤–éƒ¨APIä»•æ§˜å¤‰æ›´ç¢ºèªã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ›´æ–°

#### ç›£è¦–é …ç›®
1. **ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡**: 95%ä»¥ä¸Šç¶­æŒ
2. **APIå¿œç­”æ™‚é–“**: 95%ile 2ç§’ä»¥ä¸‹
3. **ãƒãƒƒãƒå‡¦ç†æˆåŠŸç‡**: 90%ä»¥ä¸Š
4. **é€šçŸ¥é€ä¿¡æˆåŠŸç‡**: 95%ä»¥ä¸Š

#### éšœå®³å¯¾å¿œ
1. **å¤–éƒ¨APIéšœå®³**: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã§ç¶™ç¶šã€å¾©æ—§å¾Œè‡ªå‹•åŒæœŸ
2. **Discord APIéšœå®³**: é€šçŸ¥ã‚’ä¸€æ™‚ä¿ç•™ã€å¾©æ—§å¾Œä¸€æ‹¬é€ä¿¡
3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹éšœå®³**: èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ç¶™ç¶šã€ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡

### 11.4 ä»Šå¾Œã®æ‹¡å¼µæ€§

#### çŸ­æœŸçš„æ‹¡å¼µ (3-6ãƒ¶æœˆ)
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¼·åŒ–**: Next.js/React
- **ä¾¡æ ¼å±¥æ­´ã‚°ãƒ©ãƒ•**: Chart.js ã«ã‚ˆã‚‹è¦–è¦šåŒ–
- **ã‚¸ãƒ£ãƒ³ãƒ«åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: è©³ç´°ãªæ¤œç´¢æ¡ä»¶
- **ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæ©Ÿèƒ½**: ä¾¡æ ¼ç›®æ¨™è¨­å®š

#### ä¸­æœŸçš„æ‹¡å¼µ (6-12ãƒ¶æœˆ)
- **ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª**: React Native/Flutter
- **ä»–ã‚¹ãƒˆã‚¢å¯¾å¿œ**: PlayStation Store, Nintendo eShop
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ©Ÿèƒ½

#### é•·æœŸçš„å±•æœ› (1å¹´ä»¥ä¸Š)
- **AIä¾¡æ ¼äºˆæ¸¬**: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ä¾¡æ ¼å¤‰å‹•äºˆæ¸¬
- **APIæä¾›**: ä»–ã‚µãƒ¼ãƒ“ã‚¹ã§ã®åˆ©ç”¨
- **åç›ŠåŒ–**: ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½

---

## 12. æŠ€è¡“ä»•æ§˜è©³ç´°

### 12.1 ç’°å¢ƒå¤‰æ•°è¨­å®š
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹
# Discordè¨­å®š
DISCORD_CLIENT_ID=your_client_id
DISCORD_CLIENT_SECRET=your_client_secret
DISCORD_BOT_TOKEN=your_bot_token
DISCORD_REDIRECT_URI=http://localhost:5000/auth/callback

# å¤–éƒ¨API
STEAM_API_KEY=your_steam_api_key

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
DATABASE_URL=sqlite:///data/gamebargain.db

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
SECRET_KEY=your-secret-key-32-chars-minimum
ENCRYPTION_KEY=your-encryption-key-for-tokens

# ç’°å¢ƒè¨­å®š
FLASK_ENV=development
LOG_LEVEL=DEBUG
```

### 12.2 ä¾å­˜é–¢ä¿‚ (requirements.txt)
```
Flask==2.3.3
SQLAlchemy==2.0.21
Alembic==1.11.3
discord.py==2.3.2
authlib==1.2.1
requests==2.31.0
APScheduler==3.10.4
Flask-WTF==1.1.1
python-dotenv==1.0.0
cryptography==41.0.4
Jinja2==3.1.2
click==8.1.7
```

### 12.3 Dockerè¨­å®š
```dockerfile
# Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 5000

CMD ["python", "app.py"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  gamebargain:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
    environment:
      - FLASK_ENV=production
    restart: unless-stopped
```